<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Momentus Admin Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            color: white;
            margin-bottom: 30px;
            font-size: 2.5em;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }

        .card h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .provider-card {
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .provider-card:hover {
            border-color: #667eea;
            transform: translateY(-2px);
        }

        .provider-card.active {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .model-select {
            width: 100%;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #ddd;
            font-size: 14px;
            margin-top: 10px;
        }

        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
            user-select: none;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }

        .btn:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn:active {
            transform: translateY(0px);
            box-shadow: 0 1px 4px rgba(102, 126, 234, 0.4);
            background: #4c51bf;
        }

        .btn:focus {
            outline: none;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3), 0 0 0 3px rgba(102, 126, 234, 0.2);
        }

        /* Ripple effect */
        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transition: width 0.6s, height 0.6s, top 0.6s, left 0.6s;
            transform: translate(-50%, -50%);
            z-index: 0;
        }

        .btn:active::before {
            width: 300px;
            height: 300px;
        }

        .btn > * {
            position: relative;
            z-index: 1;
        }

        .btn-secondary {
            background: #48bb78;
            box-shadow: 0 2px 8px rgba(72, 187, 120, 0.3);
        }

        .btn-secondary:hover {
            background: #38a169;
            box-shadow: 0 4px 12px rgba(72, 187, 120, 0.4);
        }

        .btn-secondary:active {
            background: #2f855a;
            transform: translateY(0px);
            box-shadow: 0 1px 4px rgba(72, 187, 120, 0.4);
        }

        .btn-secondary:focus {
            box-shadow: 0 2px 8px rgba(72, 187, 120, 0.3), 0 0 0 3px rgba(72, 187, 120, 0.2);
        }

        /* Button variants with enhanced feedback */
        .btn-danger {
            background: #e53e3e;
            box-shadow: 0 2px 8px rgba(229, 62, 62, 0.3);
        }

        .btn-danger:hover {
            background: #c53030;
            box-shadow: 0 4px 12px rgba(229, 62, 62, 0.4);
        }

        .btn-danger:active {
            background: #9c2c2c;
            transform: translateY(0px);
            box-shadow: 0 1px 4px rgba(229, 62, 62, 0.4);
        }

        .btn-danger:focus {
            box-shadow: 0 2px 8px rgba(229, 62, 62, 0.3), 0 0 0 3px rgba(229, 62, 62, 0.2);
        }

        .btn-info {
            background: #3182ce;
            box-shadow: 0 2px 8px rgba(49, 130, 206, 0.3);
        }

        .btn-info:hover {
            background: #2c5282;
            box-shadow: 0 4px 12px rgba(49, 130, 206, 0.4);
        }

        .btn-info:active {
            background: #2a4365;
            transform: translateY(0px);
            box-shadow: 0 1px 4px rgba(49, 130, 206, 0.4);
        }

        .btn-info:focus {
            box-shadow: 0 2px 8px rgba(49, 130, 206, 0.3), 0 0 0 3px rgba(49, 130, 206, 0.2);
        }

        .btn-warning {
            background: #d69e2e;
            box-shadow: 0 2px 8px rgba(214, 158, 46, 0.3);
        }

        .btn-warning:hover {
            background: #b7791f;
            box-shadow: 0 4px 12px rgba(214, 158, 46, 0.4);
        }

        .btn-warning:active {
            background: #975a16;
            transform: translateY(0px);
            box-shadow: 0 1px 4px rgba(214, 158, 46, 0.4);
        }

        .btn-warning:focus {
            box-shadow: 0 2px 8px rgba(214, 158, 46, 0.3), 0 0 0 3px rgba(214, 158, 46, 0.2);
        }

        /* Disabled button state */
        .btn:disabled {
            background: #cbd5e0 !important;
            color: #a0aec0 !important;
            cursor: not-allowed !important;
            transform: none !important;
            box-shadow: none !important;
        }

        .btn:disabled:hover {
            transform: none !important;
            box-shadow: none !important;
        }

        .btn:disabled::before {
            display: none;
        }

        /* Loading state */
        .btn.loading {
            pointer-events: none;
            position: relative;
        }

        .btn.loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 16px;
            height: 16px;
            margin: -8px 0 0 -8px;
            border: 2px solid transparent;
            border-top: 2px solid currentColor;
            border-radius: 50%;
            animation: button-spin 1s linear infinite;
        }

        .btn.loading > * {
            opacity: 0;
        }

        @keyframes button-spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Pulse animation for important actions */
        .btn-pulse {
            animation: btn-pulse 2s infinite;
        }

        @keyframes btn-pulse {
            0% { box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3), 0 0 0 0 rgba(102, 126, 234, 0.4); }
            70% { box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3), 0 0 0 10px rgba(102, 126, 234, 0); }
            100% { box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3), 0 0 0 0 rgba(102, 126, 234, 0); }
        }

        .status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .status.active {
            background: #c6f6d5;
            color: #22543d;
        }

        .status.inactive {
            background: #fed7d7;
            color: #742a2a;
        }

        .stat-box {
            text-align: center;
            padding: 15px;
            background: #f7fafc;
            border-radius: 8px;
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            color: #718096;
            font-size: 0.9em;
            margin-top: 5px;
        }

        .test-result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 6px;
            background: #f7fafc;
        }

        .test-result.success {
            background: #c6f6d5;
            color: #22543d;
        }

        .test-result.error {
            background: #fed7d7;
            color: #742a2a;
        }

        .meditation-preview {
            background: #f7fafc;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            white-space: pre-wrap;
            font-family: Georgia, serif;
            line-height: 1.8;
            max-height: 400px;
            overflow-y: auto;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 8px;
        }

        .badge.fast { background: #c6f6d5; color: #22543d; }
        .badge.medium { background: #feebc8; color: #7c2d12; }
        .badge.high { background: #bee3f8; color: #2c5282; }

        .species-summary {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .species-category {
            margin-bottom: 20px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .species-category h4 {
            margin: 0 0 10px 0;
            color: #667eea;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .species-count {
            background: #667eea;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
        }

        .species-list {
            max-height: 150px;
            overflow-y: auto;
        }

        .species-item {
            padding: 5px 0;
            border-bottom: 1px solid #e2e8f0;
            font-size: 14px;
        }

        .species-item:last-child {
            border-bottom: none;
        }

        .species-name {
            font-weight: 600;
            color: #2d3748;
        }

        .species-scientific {
            color: #718096;
            font-style: italic;
        }

        .species-source {
            float: right;
            font-size: 11px;
            background: #e2e8f0;
            padding: 1px 6px;
            border-radius: 10px;
            color: #4a5568;
        }

        .source-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .source-stat {
            text-align: center;
            padding: 10px;
            background: white;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
        }

        .source-stat.error {
            background: #fed7d7;
            border-color: #feb2b2;
        }

        .source-stat-number {
            font-size: 18px;
            font-weight: 600;
            color: #667eea;
        }

        .source-stat.error .source-stat-number {
            color: #e53e3e;
        }

        .source-stat-label {
            font-size: 12px;
            color: #718096;
            margin-top: 2px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üßò Momentus Admin Dashboard</h1>

        <!-- Current Configuration -->
        <div class="card">
            <h2>Current AI Configuration</h2>
            <div id="current-config">
                <p>Loading...</p>
            </div>
        </div>

        <!-- AI Provider Selection -->
        <div class="card">
            <h2>AI Provider & Model Selection</h2>
            <div class="grid">
                <div class="provider-card" id="provider-google" onclick="selectProvider('google')">
                    <h3>ü§ñ Google Gemini <span class="status" id="status-google">Checking...</span></h3>
                    <select class="model-select" id="model-google" onchange="updateModel('google', this.value)">
                        <option value="gemini-2.0-flash-exp">Gemini Pro <span class="badge medium">Balanced</span> <span class="badge high">High Quality</span></option>
                        <option value="gemini-1.5-flash">Gemini 1.5 Flash <span class="badge fast">Fast</span></option>
                        <option value="gemini-2.0-flash-exp">Gemini 2.0 Flash (Exp) <span class="badge fast">Very Fast</span></option>
                    </select>
                    <button class="btn" onclick="testProvider('google')" style="margin-top: 10px; width: 100%;">Test Provider</button>
                    <div id="test-result-google"></div>
                </div>

                <div class="provider-card" id="provider-anthropic" onclick="selectProvider('anthropic')">
                    <h3>üß† Anthropic Claude <span class="status" id="status-anthropic">Checking...</span></h3>
                    <select class="model-select" id="model-anthropic" onchange="updateModel('anthropic', this.value)">
                        <option value="claude-3-opus-20240229">Claude 3 Opus <span class="badge medium">Slow</span> <span class="badge high">Highest Quality</span></option>
                        <option value="claude-3-sonnet-20240229">Claude 3 Sonnet <span class="badge fast">Fast</span> <span class="badge high">Good</span></option>
                        <option value="claude-3-haiku-20240307">Claude 3 Haiku <span class="badge fast">Very Fast</span></option>
                    </select>
                    <button class="btn" onclick="testProvider('anthropic')" style="margin-top: 10px; width: 100%;">Test Provider</button>
                    <div id="test-result-anthropic"></div>
                </div>
            </div>
            <div style="margin-top: 20px;">
                <button class="btn btn-secondary" onclick="saveConfiguration()">üíæ Save Configuration</button>
            </div>
        </div>

        <!-- Test Meditation Generation -->
        <div class="card">
            <h2>Test Meditation Generation</h2>
            <div class="grid" style="grid-template-columns: 1fr 1fr;">
                <div>
                    <label>Latitude:</label>
                    <input type="number" id="test-lat" value="34.0522" step="0.0001" style="width: 100%; padding: 8px; margin: 5px 0; border-radius: 4px; border: 1px solid #ddd;">
                    <label>Longitude:</label>
                    <input type="number" id="test-lng" value="-117.2437" step="0.0001" style="width: 100%; padding: 8px; margin: 5px 0; border-radius: 4px; border: 1px solid #ddd;">
                    <button class="btn" onclick="testMeditation()" style="margin-top: 10px; width: 100%;">Generate Test Meditation</button>
                    <button class="btn" onclick="generateTwice()" style="margin-top: 10px; width: 100%; background: #4c51bf;">Generate Twice</button>
                    <button class="btn" onclick="showFeedbackModal()" style="margin-top: 10px; width: 100%; background: #28a745;">‚≠ê Rate Meditation</button>
                </div>
                <div id="meditation-output">
                    <p style="color: #718096;">Click "Generate Test Meditation" to preview</p>
                </div>
            </div>
        </div>

        <!-- Entrainment Meditation Generator -->
        <div class="card">
            <h2>üåä Entrainment & Synchronization Meditations</h2>
            <p style="color: #718096; margin-bottom: 20px;">Generate guided meditations based on natural entrainment patterns and biological synchronization phenomena.</p>
            
            <div class="grid" style="grid-template-columns: 1fr 2fr;">
                <div>
                    <label>Entrainment Theme:</label>
                    <select id="entrainment-theme" style="width: 100%; padding: 8px; margin: 5px 0; border-radius: 4px; border: 1px solid #ddd;">
                        <option value="circadian">üåÖ Circadian Rhythms</option>
                        <option value="acoustic">ü¶ó Acoustic Synchronization</option>
                        <option value="marine">üåä Marine & Tidal Rhythms</option>
                        <option value="movement">üê¶ Collective Movement</option>
                        <option value="fungal">üçÑ Fungal Network Oscillations</option>
                        <option value="ecological">üå≤ Ecological Cycles</option>
                        <option value="mixed">üîÑ Mixed Entrainment Patterns</option>
                    </select>

                    <label>Meditation Duration:</label>
                    <select id="entrainment-duration" style="width: 100%; padding: 8px; margin: 5px 0; border-radius: 4px; border: 1px solid #ddd;">
                        <option value="300">5 minutes</option>
                        <option value="600" selected>10 minutes</option>
                        <option value="900">15 minutes</option>
                        <option value="1200">20 minutes</option>
                        <option value="1800">30 minutes</option>
                    </select>

                    <label>Focus Intensity:</label>
                    <select id="entrainment-intensity" style="width: 100%; padding: 8px; margin: 5px 0; border-radius: 4px; border: 1px solid #ddd;">
                        <option value="gentle">Gentle Introduction</option>
                        <option value="moderate" selected>Moderate Focus</option>
                        <option value="deep">Deep Scientific Integration</option>
                    </select>

                    <label>Location (Optional):</label>
                    <input type="number" id="entrainment-lat" placeholder="Latitude" step="0.0001" style="width: 100%; padding: 8px; margin: 5px 0; border-radius: 4px; border: 1px solid #ddd;">
                    <input type="number" id="entrainment-lng" placeholder="Longitude" step="0.0001" style="width: 100%; padding: 8px; margin: 5px 0; border-radius: 4px; border: 1px solid #ddd;">

                    <div style="margin: 15px 0; padding: 12px; background: #f0fff4; border: 1px solid #9ae6b4; border-radius: 6px; font-size: 0.9em;">
                        <div style="color: #22543d; font-weight: bold; margin-bottom: 5px;">‚ú® Theme Examples</div>
                        <div style="color: #2f855a;">
                            <strong>Circadian:</strong> Light-dark cycles, biological clocks<br>
                            <strong>Acoustic:</strong> Fireflies, cricket choruses, cicadas<br>
                            <strong>Marine:</strong> Tidal rhythms, coral spawning<br>
                            <strong>Movement:</strong> Flocking birds, schooling fish<br>
                            <strong>Fungal:</strong> Mycelial electrical waves<br>
                            <strong>Ecological:</strong> Predator-prey cycles, forest masting
                        </div>
                    </div>

                    <button class="btn" onclick="generateEntrainmentMeditation()" style="width: 100%; background: #38a169; margin-top: 10px;">üßò‚Äç‚ôÄÔ∏è Generate Entrainment Meditation</button>
                    <button class="btn" onclick="generateEntrainmentWithTTS()" style="width: 100%; background: #3182ce; margin-top: 5px;">üîä Generate with Audio</button>
                    
                    <div id="entrainment-loading" style="display: none; margin-top: 10px; color: #38a169;">
                        <div class="loading"></div> Synchronizing with natural patterns...
                    </div>
                </div>
                
                <div id="entrainment-output">
                    <div style="color: #718096; text-align: center; padding: 40px;">
                        <div style="font-size: 3em; margin-bottom: 10px;">üåä</div>
                        <p>Select an entrainment theme and click "Generate" to create a meditation based on natural synchronization patterns</p>
                        <div style="margin-top: 15px; font-size: 0.9em; color: #a0aec0;">
                            Inspired by coupled oscillators and biological entrainment phenomena
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- H10 Participant Management -->
        <div class="card">
            <h2>‚ù§Ô∏è Polar H10 Participant Management</h2>
            <p style="color: #718096; margin-bottom: 20px;">Manage participant heart rate monitors and their unique 3-character identifiers for meditation sessions.</p>
            
            <div style="text-align: center; padding: 40px;">
                <div style="font-size: 4em; margin-bottom: 20px;">‚ù§Ô∏è</div>
                <h3 style="color: #667eea; margin-bottom: 15px;">H10 Management & Analysis</h3>
                <p style="color: #718096; margin-bottom: 25px;">Complete H10 heart rate monitoring system with biometric analysis</p>
                
                <!-- Primary H10 Pages -->
                <div style="margin-bottom: 20px;">
                    <a href="/h10-simple-management.html" class="btn" style="background: #667eea; color: white; text-decoration: none; padding: 15px 25px; border-radius: 8px; font-size: 1.1em; margin: 5px;">
                        ÔøΩ Participant Management
                    </a>
                    <a href="/h10-biometric-dashboard.html" class="btn" style="background: #28a745; color: white; text-decoration: none; padding: 15px 25px; border-radius: 8px; font-size: 1.1em; margin: 5px;">
                        üìä Biometric Analysis
                    </a>
                </div>
                
                <!-- Support & Guides -->
                <div style="margin-bottom: 15px;">
                    <a href="/h10-troubleshooting.html" class="btn" style="background: #dc3545; color: white; text-decoration: none; padding: 10px 20px; border-radius: 6px; font-size: 0.9em; margin: 3px;">
                        üîß Troubleshooting
                    </a>
                    <a href="/h10-browser-guide.html" class="btn" style="background: #6c757d; color: white; text-decoration: none; padding: 10px 20px; border-radius: 6px; font-size: 0.9em; margin: 3px;">
                        üåê Browser Guide
                    </a>
                    <a href="/h10-test-guide.html" class="btn" style="background: #17a2b8; color: white; text-decoration: none; padding: 10px 20px; border-radius: 6px; font-size: 0.9em; margin: 3px;">
                        üì° Test Guide
                    </a>
                    <a href="/h10-function-test.html" class="btn" style="background: #fd7e14; color: white; text-decoration: none; padding: 10px 20px; border-radius: 6px; font-size: 0.9em; margin: 3px;">
                        üß™ Function Test
                    </a>
                </div>
            </div>

        </div>

        <!-- Species in My Area -->
        <div class="card">
            <h2>üåç Species in My Area</h2>
            <p style="color: #718096; margin-bottom: 15px;">Discover real species in your current location using live data from iNaturalist, GBIF, and eBird. No fallback data included.</p>
            <div class="grid" style="grid-template-columns: 1fr 2fr;">
                <div>
                    <button class="btn" onclick="getMyLocationSpecies()" style="width: 100%; margin-bottom: 10px;">üìç Species in My Area</button>
                    <div style="font-size: 0.9em; color: #718096; margin-bottom: 10px;">Or enter coordinates manually:</div>
                    <label>Latitude:</label>
                    <input type="number" id="my-area-lat" value="" step="0.0001" style="width: 100%; padding: 8px; margin: 5px 0; border-radius: 4px; border: 1px solid #ddd;">
                    <label>Longitude:</label>
                    <input type="number" id="my-area-lng" value="" step="0.0001" style="width: 100%; padding: 8px; margin: 5px 0; border-radius: 4px; border: 1px solid #ddd;">
                    <button class="btn" onclick="getAreaSpecies()" style="margin-top: 10px; width: 100%;">üîç Search Area</button>
                    <div id="area-loading" style="display: none; margin-top: 10px; color: #667eea;">
                        <div class="loading"></div> Finding species...
                    </div>
                </div>
                <div id="area-results">
                    <p style="color: #718096;">Click "Species in My Area" to automatically detect your location, or enter coordinates manually</p>
                </div>
            </div>
        </div>

        <!-- Robust Species Testing with Error Monitoring -->
        <div class="card">
            <h2>üß¨ Robust Species Testing</h2>
            <p style="color: #718096; margin-bottom: 15px;">Test the new robust species system with guaranteed results. All 6 animal classes should NEVER return 0 results.</p>
            <div class="grid" style="grid-template-columns: 1fr 2fr;">
                <div>
                    <label>Species No-Repeat Days:</label>
                    <input type="number" id="species-no-repeat-days" value="2" min="0" step="1" style="width: 100%; padding: 8px; margin: 5px 0; border-radius: 4px; border: 1px solid #ddd;">
                    <button class="btn" onclick="saveSpeciesConfig()" style="margin-top: 8px; width: 100%;">Save Species Config</button>

                    <label>Test Coordinates:</label>
                    <input type="number" id="species-test-lat" value="33.9425" step="0.0001" placeholder="Latitude" style="width: 100%; padding: 8px; margin: 5px 0; border-radius: 4px; border: 1px solid #ddd;">
                    <input type="number" id="species-test-lng" value="-117.3917" step="0.0001" placeholder="Longitude" style="width: 100%; padding: 8px; margin: 5px 0; border-radius: 4px; border: 1px solid #ddd;">
                    <button class="btn" onclick="testSpeciesRobustness()" style="margin-top: 10px; width: 100%;">üî¨ Test System Robustness</button>
                    <div style="margin-top: 15px; padding: 12px; background: #fff5f5; border: 1px solid #feb2b2; border-radius: 6px; font-size: 0.9em;">
                        <div style="color: #c53030; font-weight: bold; margin-bottom: 5px;">‚ö†Ô∏è Zero Results Alert</div>
                        <div style="color: #718096;">Any species class returning 0 results indicates a critical system failure that requires immediate attention.</div>
                    </div>
                    <div id="robust-loading" style="display: none; margin-top: 10px; color: #667eea;">
                        <div class="loading"></div> Testing robustness...
                    </div>
                </div>
                <div id="robust-results">
                    <p style="color: #718096;">Test the robust species system to verify all 6 animal classes return results with comprehensive GBIF ‚Üí Regional ‚Üí Global fallbacks.</p>
                </div>
            </div>
        </div>

        <!-- System Statistics -->
        <div class="card">
            <h2>System Statistics</h2>
            <div class="grid">
                <div class="stat-box">
                    <div class="stat-number" id="stat-sessions">-</div>
                    <div class="stat-label">Active Sessions</div>
                </div>
                <div class="stat-box">
                    <div class="stat-number" id="stat-lunar">-</div>
                    <div class="stat-label">Current Lunar Day</div>
                </div>
                <div class="stat-box">
                    <div class="stat-number" id="stat-behaviors">21</div>
                    <div class="stat-label">Behavior Patterns</div>
                </div>
                <div class="stat-box">
                    <div class="stat-number" id="stat-species">5</div>
                    <div class="stat-label">Species Types</div>
                </div>
                <div class="stat-box">
                    <div class="stat-number" id="stat-gbif-circuit">‚Äî</div>
                    <div class="stat-label">GBIF Circuit</div>
                </div>
                <div style="text-align:center;">
                    <div id="gbif-circuit-countdown" style="color:#718096; font-size:12px; margin-top:6px;">&nbsp;</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Feedback Analytics -->
    <div class="card">
        <h2>üìä Feedback Analytics</h2>
        <div class="grid">
            <div class="stat-box">
                <div class="stat-number" id="feedback-total">-</div>
                <div class="stat-label">Total Feedback</div>
            </div>
            <div class="stat-box">
                <div class="stat-number" id="feedback-recent">-</div>
                <div class="stat-label">Recent (24h)</div>
            </div>
            <div class="stat-box">
                <div class="stat-number" id="feedback-avg-overall">-</div>
                <div class="stat-label">Avg Overall</div>
            </div>
            <div class="stat-box">
                <div class="stat-number" id="feedback-avg-engagement">-</div>
                <div class="stat-label">Avg Engagement</div>
            </div>
        </div>
        <div style="margin-top: 20px;">
            <h3 style="color: #667eea; margin-bottom: 10px;">Rating Averages (1-10)</h3>
            <div id="feedback-ratings-chart" style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px;">
                <!-- Rating bars will be inserted here -->
            </div>
            <div id="feedback-insights" style="background: #f7fafc; padding: 12px; border-radius: 6px; border-left: 4px solid #667eea;">
                <strong>AI Insights:</strong> <span id="insights-text">Loading...</span>
            </div>
            <div id="feedback-adjustments" style="margin-top: 15px;">
                <h4 style="color: #667eea; margin-bottom: 8px;">Current AI Adjustments</h4>
                <div id="adjustments-list" style="background: #fffaf0; padding: 10px; border-radius: 4px; font-size: 0.9em;">
                    <!-- Adjustments will be listed here -->
                </div>
            </div>
        </div>
        <button class="btn" onclick="loadFeedbackStats()" style="margin-top: 15px;">üîÑ Refresh Analytics</button>
    </div>

    <script>
        let currentProvider = 'google';
        let currentModel = 'gemini-1.5-pro';

        async function loadConfig() {
            try {
                const res = await fetch('/api/admin/ai-config');
                const data = await res.json();

                if (data.success) {
                    currentProvider = data.config.provider;
                    currentModel = data.config.model;

                    document.getElementById('current-config').innerHTML = `
                        <p><strong>Provider:</strong> ${data.config.provider}</p>
                        <p><strong>Model:</strong> ${data.config.model}</p>
                        <p><strong>Google AI:</strong> <span class="status ${data.config.providersInitialized.google ? 'active' : 'inactive'}">${data.config.providersInitialized.google ? 'Active' : 'Inactive'}</span></p>
                        <p><strong>Claude AI:</strong> <span class="status ${data.config.providersInitialized.anthropic ? 'active' : 'inactive'}">${data.config.providersInitialized.anthropic ? 'Active' : 'Inactive'}</span></p>
                    `;

                    document.getElementById('status-google').className = 'status ' + (data.config.providersInitialized.google ? 'active' : 'inactive');
                    document.getElementById('status-google').textContent = data.config.providersInitialized.google ? 'Active' : 'Inactive';

                    document.getElementById('status-anthropic').className = 'status ' + (data.config.providersInitialized.anthropic ? 'active' : 'inactive');
                    document.getElementById('status-anthropic').textContent = data.config.providersInitialized.anthropic ? 'Active' : 'Inactive';

                    selectProvider(currentProvider);
                    document.getElementById('model-' + currentProvider).value = currentModel;
                }
            } catch (error) {
                console.error('Failed to load config:', error);
            }
        }

        // Load runtime species configuration and populate the UI
        async function loadSpeciesConfig() {
            try {
                const res = await fetch('/api/admin/species-config');
                const data = await res.json();
                if (data.success && data.config) {
                    document.getElementById('species-no-repeat-days').value = data.config.noRepeatDays;
                }
            } catch (err) {
                console.warn('Failed to load species config', err);
            }
        }

        async function saveSpeciesConfig() {
            const val = document.getElementById('species-no-repeat-days').value;
            try {
                const res = await fetch('/api/admin/species-config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ noRepeatDays: Number(val) })
                });
                const data = await res.json();
                if (data.success) {
                    alert('Species configuration updated: noRepeatDays = ' + data.config.noRepeatDays);
                    // refresh stats to reflect change
                    loadStats();
                } else {
                    alert('Failed to update species configuration: ' + (data.error || 'unknown'));
                }
            } catch (err) {
                alert('Error saving species configuration: ' + err.message);
            }
        }

        async function loadStats() {
            try {
                const res = await fetch('/api/admin/stats');
                const data = await res.json();

                if (data.success) {
                    document.getElementById('stat-sessions').textContent = data.stats.session.activeSessions;
                    document.getElementById('stat-lunar').textContent = data.stats.session.lunarStats?.currentLunarDay || '-';
                    // GBIF circuit status
                    const gbifCircuit = data.stats.session.speciesStats?.gbifCircuit || data.stats.session.speciesStats || data.stats.session.gbifCircuit || null;
                    if (gbifCircuit) {
                        document.getElementById('stat-gbif-circuit').textContent = gbifCircuit.open ? 'OPEN' : 'CLOSED';
                        document.getElementById('stat-gbif-circuit').style.color = gbifCircuit.open ? '#e53e3e' : '#2f855a';
                        // Update countdown if open
                        if (gbifCircuit.open && gbifCircuit.openUntil) {
                            startGbifCountdown(gbifCircuit.openUntil);
                        } else {
                            stopGbifCountdown();
                        }
                    }
                }
            } catch (error) {
                console.error('Failed to load stats:', error);
            }
        }

        // Load feedback analytics
        async function loadFeedbackStats() {
            try {
                const res = await fetch('/api/admin/feedback-stats');
                const data = await res.json();

                if (data.success) {
                    const stats = data.stats;
                    const analysis = stats.recentAnalysis;

                    // Update basic stats
                    document.getElementById('feedback-total').textContent = stats.totalEntries;
                    document.getElementById('feedback-recent').textContent = analysis.sampleSize;
                    document.getElementById('feedback-avg-overall').textContent = analysis.averages.overall.toFixed(1);
                    document.getElementById('feedback-avg-engagement').textContent = analysis.averages.engagement.toFixed(1);

                    // Create rating bars chart
                    const chartContainer = document.getElementById('feedback-ratings-chart');
                    chartContainer.innerHTML = '';

                    const dimensions = [
                        { key: 'relevance', label: 'Relevance', color: '#667eea' },
                        { key: 'groundedness', label: 'Groundedness', color: '#48bb78' },
                        { key: 'engagement', label: 'Engagement', color: '#ed8936' },
                        { key: 'ttsQuality', label: 'TTS Quality', color: '#9f7aea' },
                        { key: 'overall', label: 'Overall', color: '#e53e3e' }
                    ];

                    dimensions.forEach(dim => {
                        const value = analysis.averages[dim.key];
                        const percentage = (value / 10) * 100;

                        const bar = document.createElement('div');
                        bar.style.cssText = `
                            flex: 1;
                            min-width: 120px;
                            text-align: center;
                        `;

                        bar.innerHTML = `
                            <div style="font-size: 0.8em; color: #666; margin-bottom: 5px;">${dim.label}</div>
                            <div style="background: #e2e8f0; height: 20px; border-radius: 10px; overflow: hidden; margin-bottom: 5px;">
                                <div style="background: ${dim.color}; height: 100%; width: ${percentage}%; border-radius: 10px; transition: width 0.3s ease;"></div>
                            </div>
                            <div style="font-weight: bold; color: ${dim.color};">${value.toFixed(1)}</div>
                        `;

                        chartContainer.appendChild(bar);
                    });

                    // Update insights
                    document.getElementById('insights-text').textContent = analysis.insights;

                    // Update adjustments
                    const adjustmentsList = document.getElementById('adjustments-list');
                    adjustmentsList.innerHTML = '';

                    if (Object.keys(analysis.adjustments).length === 0) {
                        adjustmentsList.innerHTML = '<em>No adjustments needed - ratings are strong!</em>';
                    } else {
                        Object.entries(analysis.adjustments).forEach(([key, adjustment]) => {
                            const item = document.createElement('div');
                            item.style.cssText = `
                                margin-bottom: 8px;
                                padding: 6px;
                                background: ${adjustment.priority === 'high' ? '#fed7d7' : adjustment.priority === 'medium' ? '#fef5e7' : '#f0fff4'};
                                border-radius: 4px;
                                border-left: 3px solid ${adjustment.priority === 'high' ? '#e53e3e' : adjustment.priority === 'medium' ? '#ed8936' : '#38a169'};
                            `;

                            item.innerHTML = `
                                <strong>${key.charAt(0).toUpperCase() + key.slice(1)} (${adjustment.priority} priority):</strong>
                                <ul style="margin: 4px 0 0 16px; padding: 0;">
                                    ${adjustment.suggestions.map(s => `<li style="margin: 2px 0;">${s}</li>`).join('')}
                                </ul>
                            `;

                            adjustmentsList.appendChild(item);
                        });
                    }
                }
            } catch (error) {
                console.error('Failed to load feedback stats:', error);
                document.getElementById('insights-text').textContent = 'Error loading analytics';
            }
        }

        // Countdown for GBIF circuit openUntil (ms since epoch)
        let _gbifCountdownInterval = null;
        function startGbifCountdown(openUntilMs) {
            stopGbifCountdown();
            function tick() {
                const now = Date.now();
                const delta = openUntilMs - now;
                const el = document.getElementById('gbif-circuit-countdown');
                if (!el) return;
                if (delta <= 0) {
                    el.textContent = 'Circuit will close shortly';
                    stopGbifCountdown();
                    return;
                }
                const secs = Math.floor(delta / 1000);
                const mins = Math.floor(secs / 60);
                const rem = secs % 60;
                el.textContent = `Closes in ${mins}m ${rem}s`;
            }
            tick();
            _gbifCountdownInterval = setInterval(tick, 1000);
        }

        function stopGbifCountdown() {
            if (_gbifCountdownInterval) {
                clearInterval(_gbifCountdownInterval);
                _gbifCountdownInterval = null;
            }
            const el = document.getElementById('gbif-circuit-countdown');
            if (el) el.textContent = '';
        }

        // Helper to escape HTML for safe rendering of raw snippets
        function escapeHtml(unsafe) {
            if (!unsafe) return '';
            return unsafe
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }

        async function playMockAudio(audioUrl) {
            try {
                const response = await fetch(audioUrl);
                const text = await response.text();
                
                // Create a modal-like overlay to show the audio script
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                    background: rgba(0,0,0,0.8); z-index: 1000; display: flex; 
                    align-items: center; justify-content: center; padding: 20px;
                `;
                
                const content = document.createElement('div');
                content.style.cssText = `
                    background: white; padding: 30px; border-radius: 10px; 
                    max-width: 800px; max-height: 80vh; overflow-y: auto;
                    box-shadow: 0 10px 25px rgba(0,0,0,0.3);
                `;
                
                content.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="margin: 0; color: #2d3748;">üéôÔ∏è TTS Audio Script</h3>
                        <button onclick="this.closest('[style*=fixed]').remove()" style="background: #e53e3e; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer;">‚úï Close</button>
                    </div>
                    <div style="background: #f7fafc; padding: 15px; border-radius: 6px; white-space: pre-wrap; font-family: 'Courier New', monospace; font-size: 0.9em; line-height: 1.4; color: #2d3748;">${escapeHtml(text)}</div>
                    <div style="margin-top: 20px; padding: 15px; background: #e6fffa; border-radius: 6px; border-left: 4px solid #38b2ac;">
                        <strong style="color: #234e52;">üí° About TTS Audio:</strong><br>
                        <span style="color: #2c7a7b;">When Azure TTS is configured, this text would be converted to natural-sounding British male voice (en-GB-RyanNeural) at 0.85x speed with documentary-style pacing, perfect for meditation.</span>
                    </div>
                `;
                
                modal.appendChild(content);
                document.body.appendChild(modal);
                
                // Close on background click
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) modal.remove();
                });
                
            } catch (error) {
                alert('Error loading audio script: ' + error.message);
            }
        }

        function selectProvider(provider) {
            currentProvider = provider;
            document.querySelectorAll('.provider-card').forEach(card => {
                card.classList.remove('active');
            });
            document.getElementById('provider-' + provider).classList.add('active');
        }

        function updateModel(provider, model) {
            if (provider === currentProvider) {
                currentModel = model;
            }
        }

        async function testProvider(provider) {
            const model = document.getElementById('model-' + provider).value;
            const resultDiv = document.getElementById('test-result-' + provider);

            resultDiv.innerHTML = '<div class="test-result"><span class="loading"></span> Testing...</div>';

            try {
                const res = await fetch('/api/admin/test-ai', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ provider, model })
                });

                const data = await res.json();

                if (data.result.success) {
                    resultDiv.innerHTML = `
                        <div class="test-result success">
                            ‚úÖ Success! Response: ${data.result.responseLength} chars<br>
                            Tokens: ${data.result.usage.totalTokens}
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="test-result error">
                            ‚ùå Failed: ${data.result.error}
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="test-result error">‚ùå Error: ${error.message}</div>`;
            }
        }

        async function saveConfiguration() {
            try {
                const res = await fetch('/api/admin/ai-config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        provider: currentProvider,
                        model: currentModel
                    })
                });

                const data = await res.json();

                if (data.success) {
                    alert('‚úÖ Configuration saved successfully!');
                    loadConfig();
                } else {
                    alert('‚ùå Failed to save configuration: ' + data.error);
                }
            } catch (error) {
                alert('‚ùå Error: ' + error.message);
            }
        }

        async function testMeditation() {
            const lat = document.getElementById('test-lat').value;
            const lng = document.getElementById('test-lng').value;
            const outputDiv = document.getElementById('meditation-output');

            outputDiv.innerHTML = '<div class="loading"></div> Generating meditation...';

            try {
                const res = await fetch('/api/admin/test-meditation', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        latitude: parseFloat(lat),
                        longitude: parseFloat(lng),
                        provider: currentProvider,
                        model: currentModel
                    })
                });

                const data = await res.json();

                if (data.success) {
                    outputDiv.innerHTML = `
                        <div class="meditation-preview">${data.session.content.text}</div>
                        <p style="margin-top: 10px; color: #718096;">
                            Species: ${data.session.species.name} |
                            Lunar: Day ${data.session.lunar.day} (${data.session.lunar.phase}) |
                            Duration: ${data.session.content.duration}s
                        </p>
                    `;
                } else {
                    outputDiv.innerHTML = '<div class="test-result error">Failed to generate meditation</div>';
                }
            } catch (error) {
                outputDiv.innerHTML = '<div class="test-result error">Error: ' + error.message + '</div>';
            }
        }

        // Generate two meditations in a row and show them side-by-side for comparison
        async function generateTwice() {
            const lat = document.getElementById('test-lat').value;
            const lng = document.getElementById('test-lng').value;
            const outputDiv = document.getElementById('meditation-output');

            outputDiv.innerHTML = '<div class="loading"></div> Generating two meditations...';

            try {
                const payload = {
                    latitude: parseFloat(lat),
                    longitude: parseFloat(lng),
                    provider: currentProvider,
                    model: currentModel
                };

                // Run sequentially to make behavior deterministic for repeat/no-repeat testing
                const results = [];
                for (let i = 0; i < 2; i++) {
                    const res = await fetch('/api/admin/test-meditation', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    const data = await res.json();
                    if (!data || !data.success) {
                        throw new Error((data && data.error) || 'Failed to generate meditation');
                    }
                    results.push(data.session);
                }

                // Helper to escape regex chars
                function escapeRegExp(string) {
                    return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                }

                // Build comparison UI
                const left = results[0];
                const right = results[1];

                const leftSpecies = left.species?.name || '‚Äî';
                const rightSpecies = right.species?.name || '‚Äî';

                // Highlight species name occurrences inside the meditation text (case-insensitive)
                function highlightSpecies(text, speciesName) {
                    if (!speciesName) return escapeHtml(text);
                    const escaped = escapeRegExp(speciesName);
                    try {
                        const re = new RegExp('(' + escaped + ')', 'ig');
                        return escapeHtml(text).replace(re, '<mark>$1</mark>');
                    } catch (e) {
                        return escapeHtml(text);
                    }
                }

                const html = `
                    <div style="display:flex; gap:12px; align-items:flex-start;">
                        <div style="flex:1;">
                            <div class="meditation-preview">${highlightSpecies(left.content.text || '', leftSpecies)}</div>
                            <p style="margin-top:8px; color:#718096; font-size:0.95em;">Species: <strong>${escapeHtml(leftSpecies)}</strong> | Lunar: ${escapeHtml(String(left.lunar?.phase || ''))} | Duration: ${escapeHtml(String(left.content?.duration || ''))}s</p>
                        </div>
                        <div style="flex:1;">
                            <div class="meditation-preview">${highlightSpecies(right.content.text || '', rightSpecies)}</div>
                            <p style="margin-top:8px; color:#718096; font-size:0.95em;">Species: <strong>${escapeHtml(rightSpecies)}</strong> | Lunar: ${escapeHtml(String(right.lunar?.phase || ''))} | Duration: ${escapeHtml(String(right.content?.duration || ''))}s</p>
                        </div>
                    </div>
                    <div style="margin-top:10px;">
                        <strong>Comparison:</strong> ${escapeHtml(leftSpecies) === escapeHtml(rightSpecies) ? '<span style="color:#2f855a;">Same species selected</span>' : '<span style="color:#dd6b20;">Different species selected</span>'}
                    </div>
                `;

                outputDiv.innerHTML = html;

            } catch (error) {
                outputDiv.innerHTML = '<div class="test-result error">Error: ' + escapeHtml(error.message || String(error)) + '</div>';
            }
        }

        // Generate entrainment meditation
        async function generateEntrainmentMeditation() {
            const theme = document.getElementById('entrainment-theme').value;
            const duration = document.getElementById('entrainment-duration').value;
            const intensity = document.getElementById('entrainment-intensity').value;
            const lat = document.getElementById('entrainment-lat').value;
            const lng = document.getElementById('entrainment-lng').value;
            
            const loadingEl = document.getElementById('entrainment-loading');
            const outputDiv = document.getElementById('entrainment-output');

            loadingEl.style.display = 'block';
            outputDiv.innerHTML = '';

            try {
                const requestBody = {
                    theme: theme,
                    duration: parseInt(duration),
                    intensity: intensity,
                    latitude: lat ? parseFloat(lat) : null,
                    longitude: lng ? parseFloat(lng) : null
                };

                const response = await fetch('/api/admin/generate-entrainment', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });

                const data = await response.json();
                loadingEl.style.display = 'none';

                if (data.success) {
                    const meditation = data.meditation;
                    const metadata = data.metadata || {};
                    
                    // Theme descriptions
                    const themeDescriptions = {
                        circadian: 'üåÖ Circadian Rhythms - Internal biological clocks synchronized to light-dark cycles',
                        acoustic: 'ü¶ó Acoustic Synchronization - Fireflies, crickets, and cicadas creating synchronized choruses',
                        marine: 'üåä Marine & Tidal Rhythms - Coastal organisms entrained to tidal cycles and coral spawning',
                        movement: 'üê¶ Collective Movement - Flocking birds and schooling fish demonstrating locomotor entrainment',
                        fungal: 'üçÑ Fungal Network Oscillations - Mycelial electrical waves synchronizing across fungal bodies',
                        ecological: 'üå≤ Ecological Cycles - Predator-prey populations and forest masting cycles',
                        mixed: 'üîÑ Mixed Entrainment Patterns - Combination of multiple natural synchronization phenomena'
                    };

                    const intensityLabels = {
                        gentle: 'Gentle Introduction',
                        moderate: 'Moderate Focus',
                        deep: 'Deep Scientific Integration'
                    };

                    const html = `
                        <div class="meditation-preview">${escapeHtml(meditation.text || meditation)}</div>
                        <div style="margin-top: 15px; padding: 12px; background: #f0fff4; border: 1px solid #9ae6b4; border-radius: 6px;">
                            <div style="color: #22543d; font-weight: bold; margin-bottom: 8px;">üìä Meditation Details</div>
                            <div style="color: #2f855a; font-size: 0.9em;">
                                <strong>Theme:</strong> ${themeDescriptions[theme] || theme}<br>
                                <strong>Duration:</strong> ${Math.floor(duration/60)} minutes (${duration} seconds)<br>
                                <strong>Intensity:</strong> ${intensityLabels[intensity] || intensity}<br>
                                ${lat && lng ? `<strong>Location:</strong> ${lat}, ${lng}<br>` : ''}
                                ${metadata.focusPatterns ? `<strong>Focus Patterns:</strong> ${metadata.focusPatterns.join(', ')}<br>` : ''}
                                ${metadata.scientificConcepts ? `<strong>Scientific Concepts:</strong> ${metadata.scientificConcepts.join(', ')}<br>` : ''}
                            </div>
                        </div>
                        <div style="margin-top: 10px; text-align: center;">
                            <button class="btn" onclick="generateEntrainmentWithTTS()" style="background: #3182ce; margin-right: 10px;">üîä Generate Audio Version</button>
                            <button class="btn" onclick="showFeedbackModal()" style="background: #28a745;">‚≠ê Rate Meditation</button>
                        </div>
                    `;

                    outputDiv.innerHTML = html;
                } else {
                    outputDiv.innerHTML = '<div class="test-result error">Failed to generate entrainment meditation: ' + (data.error || 'Unknown error') + '</div>';
                }
            } catch (error) {
                loadingEl.style.display = 'none';
                outputDiv.innerHTML = '<div class="test-result error">Error: ' + error.message + '</div>';
            }
        }

        // Generate entrainment meditation with TTS
        async function generateEntrainmentWithTTS() {
            const theme = document.getElementById('entrainment-theme').value;
            const duration = document.getElementById('entrainment-duration').value;
            const intensity = document.getElementById('entrainment-intensity').value;
            const lat = document.getElementById('entrainment-lat').value;
            const lng = document.getElementById('entrainment-lng').value;
            
            const loadingEl = document.getElementById('entrainment-loading');
            const outputDiv = document.getElementById('entrainment-output');

            loadingEl.style.display = 'block';
            outputDiv.innerHTML = '';

            try {
                const requestBody = {
                    theme: theme,
                    duration: parseInt(duration),
                    intensity: intensity,
                    latitude: lat ? parseFloat(lat) : null,
                    longitude: lng ? parseFloat(lng) : null,
                    generateAudio: true
                };

                const response = await fetch('/api/admin/generate-entrainment', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });

                const data = await response.json();
                loadingEl.style.display = 'none';

                if (data.success) {
                    const meditation = data.meditation;
                    const metadata = data.metadata || {};
                    const audioUrl = data.audioUrl;
                    
                    const themeDescriptions = {
                        circadian: 'üåÖ Circadian Rhythms',
                        acoustic: 'ü¶ó Acoustic Synchronization',
                        marine: 'üåä Marine & Tidal Rhythms',
                        movement: 'üê¶ Collective Movement',
                        fungal: 'üçÑ Fungal Network Oscillations',
                        ecological: 'üå≤ Ecological Cycles',
                        mixed: 'üîÑ Mixed Entrainment Patterns'
                    };

                    const isMockAudio = metadata && metadata.isMock;
                    const scriptUrl = isMockAudio && audioUrl ? audioUrl.replace('.wav', '.txt') : null;
                    
                    const html = `
                        <div class="meditation-preview">${escapeHtml(meditation.text || meditation)}</div>
                        ${audioUrl ? `
                            <div style="margin: 15px 0; padding: 15px; background: #e6fffa; border: 1px solid #4fd1c7; border-radius: 6px; text-align: center;">
                                ${isMockAudio ? `
                                    <div style="color: #234e52; font-weight: bold; margin-bottom: 10px;">üîß Development Audio (Mock TTS)</div>
                                    <div style="background: #fff3cd; border: 1px solid #ffecb5; padding: 10px; border-radius: 4px; margin-bottom: 10px;">
                                        <div style="color: #856404; font-size: 0.9em;">
                                            <strong>ÔøΩÔ∏è Development Mode:</strong> Real TTS audio disabled.<br>
                                            This shows what would be generated with Azure TTS.
                                        </div>
                                    </div>
                                    <button onclick="playMockAudio('${audioUrl}')" class="btn" style="background: #17a2b8; margin-right: 10px;">
                                        üìñ View Audio Script
                                    </button>
                                ` : `
                                    <div style="color: #234e52; font-weight: bold; margin-bottom: 10px;">ÔøΩüîä Audio Meditation</div>
                                    <audio controls style="width: 100%; max-width: 400px;">
                                        <source src="${audioUrl}" type="audio/mpeg">
                                        Your browser does not support the audio element.
                                    </audio>
                                `}
                                <div style="margin-top: 8px;">
                                    <a href="${audioUrl}" download style="color: #2c7a7b; text-decoration: none;">üì• Download ${isMockAudio ? 'Script' : 'Audio'}</a>
                                </div>
                            </div>
                        ` : ''}
                        <div style="margin-top: 15px; padding: 12px; background: #f0fff4; border: 1px solid #9ae6b4; border-radius: 6px;">
                            <div style="color: #22543d; font-weight: bold; margin-bottom: 8px;">üìä Meditation Details</div>
                            <div style="color: #2f855a; font-size: 0.9em;">
                                <strong>Theme:</strong> ${themeDescriptions[theme] || theme}<br>
                                <strong>Duration:</strong> ${Math.floor(duration/60)} minutes<br>
                                <strong>Intensity:</strong> ${intensity}<br>
                                ${lat && lng ? `<strong>Location:</strong> ${lat}, ${lng}<br>` : ''}
                                ${audioUrl ? '<strong>Audio:</strong> Generated with TTS<br>' : ''}
                            </div>
                        </div>
                        <div style="margin-top: 10px; text-align: center;">
                            <button class="btn" onclick="showFeedbackModal()" style="background: #28a745;">‚≠ê Rate Meditation</button>
                        </div>
                    `;

                    outputDiv.innerHTML = html;
                } else {
                    outputDiv.innerHTML = '<div class="test-result error">Failed to generate entrainment meditation with audio: ' + (data.error || 'Unknown error') + '</div>';
                }
            } catch (error) {
                loadingEl.style.display = 'none';
                outputDiv.innerHTML = '<div class="test-result error">Error: ' + error.message + '</div>';
            }
        }

        async function getMyLocationSpecies() {
            const loadingEl = document.getElementById('area-loading');
            const resultsEl = document.getElementById('area-results');

            if (!navigator.geolocation) {
                alert('Geolocation is not supported by this browser');
                return;
            }

            loadingEl.style.display = 'block';
            resultsEl.innerHTML = '';

            navigator.geolocation.getCurrentPosition(
                async (position) => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    
                    // Update input fields
                    document.getElementById('my-area-lat').value = lat.toFixed(6);
                    document.getElementById('my-area-lng').value = lng.toFixed(6);
                    
                    await testSpeciesAtLocation(lat, lng, loadingEl, resultsEl);
                },
                (error) => {
                    loadingEl.style.display = 'none';
                    let errorMsg = 'Unable to get location: ';
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMsg += 'Location access denied by user.';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMsg += 'Location information unavailable.';
                            break;
                        case error.TIMEOUT:
                            errorMsg += 'Location request timed out.';
                            break;
                    }
                    resultsEl.innerHTML = `<div style="color: #e53e3e; padding: 10px; background: #fed7d7; border-radius: 4px;">${errorMsg}</div>`;
                }
            );
        }

        async function getAreaSpecies() {
            const lat = document.getElementById('my-area-lat').value;
            const lng = document.getElementById('my-area-lng').value;
            const loadingEl = document.getElementById('area-loading');
            const resultsEl = document.getElementById('area-results');

            if (!lat || !lng) {
                alert('Please enter both latitude and longitude or use "Species in My Area" for automatic detection');
                return;
            }

            // Use the new robust species testing
            await testSpeciesAtLocation(parseFloat(lat), parseFloat(lng), loadingEl, resultsEl);
        }

        // New function that uses robust species testing  
        async function testSpeciesAtLocation(lat, lng, loadingEl, resultsEl) {
            loadingEl.style.display = 'block';
            resultsEl.innerHTML = '';

            try {
                const response = await fetch('/api/admin/test-species', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ latitude: lat, longitude: lng })
                });

                const data = await response.json();

                if (data.success) {
                    let html = `
                        <div style="margin-bottom: 15px; padding: 10px; background: ${data.summary.hasZeroResults ? '#fff5f5' : '#f0fff4'}; border-radius: 6px;">
                            <div style="color: ${data.summary.hasZeroResults ? '#c53030' : '#38a169'}; font-weight: bold;">
                                ${data.summary.hasZeroResults ? '‚ùå SYSTEM ISSUES' : '‚úÖ SYSTEM HEALTHY'}
                            </div>
                            <div style="color: #718096; margin-top: 5px;">
                                üìç ${lat.toFixed(4)}, ${lng.toFixed(4)} | 
                                ${data.summary.successfulClasses}/${data.summary.totalClasses} classes returned species
                            </div>
                        </div>
                    `;

                    // Show GBIF diagnostic if present
                    if (data.gbifDiagnostic) {
                        html += `
                            <div style="margin-top:12px; padding:10px; background:#fffaf0; border-radius:6px; border:1px solid #f6e05e;">
                                <strong style="color:#744210;">GBIF Diagnostic:</strong>
                                <div style="color:#744210; font-size:0.9em; margin-top:6px;">${escapeHtml(data.gbifDiagnostic.message || '')}</div>
                                ${data.gbifDiagnostic.rawSnippet ? `<pre style="background:#fff; padding:8px; border-radius:4px; overflow:auto; margin-top:6px;">${escapeHtml(data.gbifDiagnostic.rawSnippet)}</pre>` : ''}
                            </div>
                        `;
                    }

                    data.results.forEach(result => {
                        const isHealthy = result.count > 0;
                        const statusColor = isHealthy ? '#38a169' : '#c53030';
                        const bgColor = isHealthy ? '#f0fff4' : '#fff5f5';

                        html += `
                            <div style="margin-bottom: 10px; padding: 12px; background: ${bgColor}; border-radius: 6px; border-left: 4px solid ${statusColor};">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                    <h4 style="margin: 0; color: #2d3748;">${result.class}</h4>
                                    <span style="color: ${statusColor}; font-weight: bold;">
                                        ${isHealthy ? '‚úÖ ' + result.count + ' species' : '‚ùå NO RESULTS'}
                                    </span>
                                </div>
                                ${result.species.length > 0 ? `
                                    <div style="color: #718096; font-size: 0.9em; margin-bottom: 5px;">
                                        Examples: ${result.species.slice(0, 3).join(', ')}
                                    </div>
                                    <div style="color: #a0aec0; font-size: 0.8em;">
                                        Sources: ${result.sources.join(', ')}
                                    </div>
                                ` : `
                                    <div style="color: #c53030; font-size: 0.9em;">
                                        ‚ö†Ô∏è System failure - no fallbacks worked
                                    </div>
                                `}
                            </div>
                        `;
                    });

                    resultsEl.innerHTML = html;
                } else {
                    resultsEl.innerHTML = `<div style="color: #c53030; padding: 12px; background: #fed7d7; border-radius: 6px;"><strong>Error:</strong> ${data.error}</div>`;
                }

            } catch (error) {
                resultsEl.innerHTML = `<div style="color: #c53030; padding: 12px; background: #fed7d7; border-radius: 6px;"><strong>Connection Error:</strong> ${error.message}</div>`;
            } finally {
                loadingEl.style.display = 'none';
            }
        }

        // Old functions removed - now using testSpeciesAtLocation for all species testing

        async function testSpeciesIdentification() {
            const lat = parseFloat(document.getElementById('species-test-lat').value);
            const lng = parseFloat(document.getElementById('species-test-lng').value);

            if (isNaN(lat) || isNaN(lng) || lat < -90 || lat > 90 || lng < -180 || lng > 180) {
                alert('Please enter valid coordinates (lat: -90 to 90, lng: -180 to 180)');
                return;
            }

            const loadingEl = document.getElementById('species-loading');
            const resultsEl = document.getElementById('species-results');

            loadingEl.style.display = 'block';
            resultsEl.innerHTML = '<p style="color: #718096;">Testing in progress...</p>';

            try {
                const response = await fetch('/api/admin/test-species', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ latitude: lat, longitude: lng })
                });

                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.error || 'Species test failed');
                }

                // Build results HTML
                let html = `
                    <div class="species-summary">
                        <h3>üìä Species Summary</h3>
                        <p><strong>Location:</strong> ${lat.toFixed(4)}, ${lng.toFixed(4)}</p>
                        <p><strong>Total Unique Species:</strong> ${data.summary.total}</p>
                    </div>

                    <div class="source-stats">
                        <div class="source-stat ${data.sourceStats.iNaturalist.error ? 'error' : ''}">
                            <div class="source-stat-number">${data.sourceStats.iNaturalist.count}</div>
                            <div class="source-stat-label">iNaturalist${data.sourceStats.iNaturalist.error ? ' (Error)' : ''}</div>
                        </div>
                        <div class="source-stat ${data.sourceStats.GBIF.error ? 'error' : ''}">
                            <div class="source-stat-number">${data.sourceStats.GBIF.count}</div>
                            <div class="source-stat-label">GBIF${data.sourceStats.GBIF.error ? ' (Error)' : ''}</div>
                        </div>
                        <div class="source-stat ${data.sourceStats.eBird.error ? 'error' : ''}">
                            <div class="source-stat-number">${data.sourceStats.eBird.count}</div>
                            <div class="source-stat-label">eBird${data.sourceStats.eBird.error ? ' (Error)' : ''}</div>
                        </div>
                    </div>
                `;

                // Add category breakdowns (insects excluded from species selection)
                const categoryOrder = ['bird', 'mammal', 'amphibian', 'reptile', 'fish', 'other'];
                const categoryIcons = {
                    bird: 'üê¶',
                    mammal: 'üêæ',
                    amphibian: 'üê∏',
                    reptile: 'ü¶é',
                    fish: 'üêü',
                    other: '‚ùì'
                };

                categoryOrder.forEach(category => {
                    const species = data.categories[category] || [];
                    if (species.length > 0) {
                        html += `
                            <div class="species-category">
                                <h4>
                                    ${categoryIcons[category]} ${category.charAt(0).toUpperCase() + category.slice(1)}s
                                    <span class="species-count">${species.length}</span>
                                </h4>
                                <div class="species-list">
                        `;

                        species.forEach(s => {
                            html += `
                                <div class="species-item">
                                    <span class="species-name">${s.name}</span>
                                    ${s.scientificName ? `<br><span class="species-scientific">${s.scientificName}</span>` : ''}
                                    <span class="species-source">${s.source}</span>
                                </div>
                            `;
                        });

                        html += `
                                </div>
                            </div>
                        `;
                    }
                });

                if (data.summary.total === 0) {
                    html += `
                        <div class="species-category">
                            <h4>‚ö†Ô∏è No Species Found</h4>
                            <p style="color: #718096;">No species were found from any real-time API sources for this location. This indicates:</p>
                            <ul style="color: #718096; margin-left: 20px;">
                                <li>Remote location with limited observations</li>
                                <li>Recent API changes or connectivity issues</li>
                                <li>Location over water or in urban areas</li>
                            </ul>
                            <p style="color: #e53e3e; margin-top: 10px;"><strong>The system would fall back to the curated species database for meditation generation.</strong></p>
                        </div>
                    `;
                }

                resultsEl.innerHTML = html;

            } catch (error) {
                resultsEl.innerHTML = `
                    <div class="test-result error">
                        <strong>Error:</strong> ${error.message}
                    </div>
                `;
            } finally {
                loadingEl.style.display = 'none';
            }
        }

        // Test robust species system with error monitoring
        async function testSpeciesRobustness() {
            const loadingEl = document.getElementById('robust-loading');
            const resultsEl = document.getElementById('robust-results');
            const latInput = document.getElementById('species-test-lat');
            const lngInput = document.getElementById('species-test-lng');

            const lat = parseFloat(latInput.value);
            const lng = parseFloat(lngInput.value);

            if (isNaN(lat) || isNaN(lng)) {
                alert('Please enter valid latitude and longitude coordinates');
                return;
            }

            loadingEl.style.display = 'block';
            resultsEl.innerHTML = '';

            try {
                const response = await fetch('/api/admin/test-species', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ latitude: lat, longitude: lng })
                });

                const data = await response.json();

                if (data.success) {
                    let html = `
                        <div style="margin-bottom: 15px; padding: 10px; background: ${data.summary.hasZeroResults ? '#fff5f5' : '#f0fff4'}; border-radius: 6px;">
                            <div style="color: ${data.summary.hasZeroResults ? '#c53030' : '#38a169'}; font-weight: bold;">
                                ${data.summary.hasZeroResults ? '‚ùå SYSTEM FAILURE DETECTED' : '‚úÖ SYSTEM HEALTHY'}
                            </div>
                            <div style="color: #718096; margin-top: 5px;">
                                Location: ${lat.toFixed(4)}, ${lng.toFixed(4)} | 
                                ${data.summary.successfulClasses}/${data.summary.totalClasses} classes returned results
                            </div>
                        </div>
                    `;

                    // Show results for each taxonomic class
                    data.results.forEach(result => {
                        const isError = result.count === 0;
                        const statusColor = isError ? '#c53030' : '#38a169';
                        const bgColor = isError ? '#fff5f5' : '#f0fff4';

                        html += `
                            <div style="margin-bottom: 10px; padding: 12px; background: ${bgColor}; border-radius: 6px; border-left: 4px solid ${statusColor};">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                    <h4 style="margin: 0; color: #2d3748;">${result.class}</h4>
                                    <span style="color: ${statusColor}; font-weight: bold;">
                                        ${isError ? '‚ùå ZERO RESULTS' : '‚úÖ ' + result.count + ' species'}
                                    </span>
                                </div>
                                ${result.species.length > 0 ? `
                                    <div style="color: #718096; font-size: 0.9em; margin-bottom: 5px;">
                                        Sample species: ${result.species.join(', ')}
                                    </div>
                                    <div style="color: #a0aec0; font-size: 0.8em;">
                                        Sources: ${result.sources.join(', ')}
                                    </div>
                                ` : `
                                    <div style="color: #c53030; font-size: 0.9em; font-weight: bold;">
                                        CRITICAL ERROR: No fallbacks worked for this class!
                                    </div>
                                `}
                            </div>
                        `;
                    });

                    // Show any system errors
                    if (data.errors && data.errors.length > 0) {
                        html += `
                            <div style="margin-top: 15px; padding: 12px; background: #fed7d7; border-radius: 6px;">
                                <h4 style="color: #c53030; margin: 0 0 10px 0;">System Errors:</h4>
                                ${data.errors.map(error => `
                                    <div style="color: #c53030; font-size: 0.9em; margin-bottom: 5px;">
                                        <strong>${error.class}:</strong> ${error.message}
                                    </div>
                                `).join('')}
                            </div>
                        `;
                    }

                    // GBIF diagnostic (if present)
                    if (data.gbifDiagnostic) {
                        html += `
                            <div style="margin-top:15px; padding:12px; background:#fffaf0; border-radius:6px; border:1px solid #f6e05e;">
                                <h4 style="margin:0; color:#744210;">GBIF Diagnostic</h4>
                                <div style="color:#744210; margin-top:6px;">${escapeHtml(data.gbifDiagnostic.message || '')}</div>
                                ${data.gbifDiagnostic.rawSnippet ? `<pre style="background:#fff; padding:8px; border-radius:4px; overflow:auto; margin-top:8px;">${escapeHtml(data.gbifDiagnostic.rawSnippet)}</pre>` : ''}
                            </div>
                        `;
                    }

                    resultsEl.innerHTML = html;
                } else {
                    resultsEl.innerHTML = `
                        <div style="color: #c53030; padding: 12px; background: #fed7d7; border-radius: 6px;">
                            <strong>Test Failed:</strong> ${data.error}
                        </div>
                    `;
                }

            } catch (error) {
                console.error('Species robustness test error:', error);
                resultsEl.innerHTML = `
                    <div style="color: #c53030; padding: 12px; background: #fed7d7; border-radius: 6px;">
                        <strong>Connection Error:</strong> ${error.message}
                    </div>
                `;
            } finally {
                loadingEl.style.display = 'none';
            }
        }

        // Feedback Modal Functions
        function showFeedbackModal() {
            document.getElementById('feedback-modal').style.display = 'flex';
            updateSliderValues();
        }

        function closeFeedbackModal() {
            document.getElementById('feedback-modal').style.display = 'none';
        }

        function updateSliderValues() {
            document.getElementById('relevance-value').textContent = document.getElementById('rating-relevance').value;
            document.getElementById('groundedness-value').textContent = document.getElementById('rating-groundedness').value;
            document.getElementById('engagement-value').textContent = document.getElementById('rating-engagement').value;
            document.getElementById('tts-value').textContent = document.getElementById('rating-tts').value;
            document.getElementById('overall-value').textContent = document.getElementById('rating-overall').value;
        }

        // Update values on slider change
        document.getElementById('rating-relevance').addEventListener('input', () => document.getElementById('relevance-value').textContent = document.getElementById('rating-relevance').value);
        document.getElementById('rating-groundedness').addEventListener('input', () => document.getElementById('groundedness-value').textContent = document.getElementById('rating-groundedness').value);
        document.getElementById('rating-engagement').addEventListener('input', () => document.getElementById('engagement-value').textContent = document.getElementById('rating-engagement').value);
        document.getElementById('rating-tts').addEventListener('input', () => document.getElementById('tts-value').textContent = document.getElementById('rating-tts').value);
        document.getElementById('rating-overall').addEventListener('input', () => document.getElementById('overall-value').textContent = document.getElementById('rating-overall').value);

        async function submitFeedback() {
            const feedback = {
                relevance: parseInt(document.getElementById('rating-relevance').value),
                groundedness: parseInt(document.getElementById('rating-groundedness').value),
                engagement: parseInt(document.getElementById('rating-engagement').value),
                ttsQuality: parseInt(document.getElementById('rating-tts').value),
                overall: parseInt(document.getElementById('rating-overall').value),
                comments: document.getElementById('feedback-comments').value.trim(),
                timestamp: new Date().toISOString(),
                sessionId: 'admin-test-' + Date.now() // Placeholder for session tracking
            };

            try {
                const response = await fetch('/api/admin/feedback', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(feedback)
                });

                if (response.ok) {
                    alert('Thank you for your feedback!');
                    closeFeedbackModal();
                    // Reset form
                    document.getElementById('feedback-form').reset();
                    updateSliderValues();
                } else {
                    alert('Failed to submit feedback. Please try again.');
                }
            } catch (error) {
                console.error('Feedback submission error:', error);
                alert('Error submitting feedback: ' + error.message);
            }
        }

        // H10 Participant Management
        let participants = JSON.parse(localStorage.getItem('h10_participants') || '[]');

        function addParticipant() {
            console.log('addParticipant() called'); // Debug log
            
            const id = document.getElementById('participant-id').value.trim().toUpperCase();
            const name = document.getElementById('participant-name').value.trim();
            const deviceId = document.getElementById('h10-device-id').value.trim();
            const notes = document.getElementById('participant-notes').value.trim();

            console.log('Form values:', { id, name, deviceId, notes }); // Debug log

            // Validation
            if (!id || id.length !== 3) {
                alert('Please enter a 3-character participant ID (e.g., ABC)');
                return;
            }

            if (!name) {
                alert('Please enter the participant name');
                return;
            }

            if (!deviceId) {
                alert('Please enter the H10 device ID');
                return;
            }

            // Check for duplicate ID
            if (participants.find(p => p.id === id)) {
                alert(`Participant ID "${id}" already exists. Please use a different ID.`);
                return;
            }

            // Add participant
            const participant = {
                id,
                name,
                deviceId,
                notes,
                addedAt: new Date().toISOString(),
                lastSeen: null,
                connected: false
            };

            participants.push(participant);
            saveParticipants();
            renderParticipants();
            clearAddForm();

            alert(`Participant ${name} (${id}) added successfully!`);
        }

        function removeParticipant(id) {
            if (confirm(`Remove participant ${id}? This cannot be undone.`)) {
                participants = participants.filter(p => p.id !== id);
                saveParticipants();
                renderParticipants();
            }
        }

        function saveParticipants() {
            localStorage.setItem('h10_participants', JSON.stringify(participants));
        }

        function clearAddForm() {
            document.getElementById('participant-id').value = '';
            document.getElementById('participant-name').value = '';
            document.getElementById('h10-device-id').value = '';
            document.getElementById('participant-notes').value = '';
        }

        function renderParticipants() {
            console.log('renderParticipants() called, participants:', participants); // Debug log
            const container = document.getElementById('participants-list');
            
            if (!container) {
                console.error('participants-list container not found!'); // Debug log
                return;
            }
            
            if (participants.length === 0) {
                container.innerHTML = `
                    <div style="color: #718096; text-align: center; padding: 40px;">
                        <div style="font-size: 3em; margin-bottom: 10px;">‚ù§Ô∏è</div>
                        <p>No participants registered yet</p>
                        <div style="margin-top: 15px; font-size: 0.9em; color: #a0aec0;">
                            Add participants with their H10 devices to track heart rate during meditation sessions
                        </div>
                    </div>
                `;
                return;
            }

            let html = `
                <div style="margin-bottom: 15px;">
                    <h3 style="color: #667eea; margin-bottom: 10px;">Registered Participants (${participants.length})</h3>
                    <button class="btn" onclick="exportParticipants()" style="background: #805ad5; margin-right: 5px;">üì§ Export Data</button>
                    <button class="btn" onclick="importParticipants()" style="background: #38b2ac;">üì• Import Data</button>
                </div>
            `;

            participants.forEach(participant => {
                const statusColor = participant.connected ? '#38a169' : '#718096';
                const statusIcon = participant.connected ? 'üü¢' : '‚ö™';
                const addedDate = new Date(participant.addedAt).toLocaleDateString();
                
                html += `
                    <div style="background: #f7fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 15px; margin-bottom: 10px;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                            <div>
                                <div style="font-weight: bold; font-size: 1.1em; color: #2d3748;">
                                    ${statusIcon} ${participant.name} 
                                    <span style="background: #667eea; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.8em; margin-left: 8px;">${participant.id}</span>
                                </div>
                                <div style="color: ${statusColor}; font-size: 0.9em; margin-top: 2px;">
                                    ${participant.connected ? 'Connected' : 'Disconnected'}
                                </div>
                            </div>
                            <button onclick="removeParticipant('${participant.id}')" style="background: #e53e3e; color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer; font-size: 0.8em;">‚ùå Remove</button>
                        </div>
                        
                        <div style="font-size: 0.9em; color: #4a5568; margin-bottom: 8px;">
                            <strong>Device:</strong> ${participant.deviceId}
                        </div>
                        
                        ${participant.notes ? `<div style="font-size: 0.9em; color: #4a5568; margin-bottom: 8px;"><strong>Notes:</strong> ${participant.notes}</div>` : ''}
                        
                        <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.8em; color: #718096;">
                            <span>Added: ${addedDate}</span>
                            <div>
                                <button onclick="testH10Connection('${participant.id}')" class="btn" style="font-size: 0.8em; padding: 4px 8px; margin-right: 5px;">üîç Test Connection</button>
                                <button onclick="startH10Session('${participant.id}')" class="btn" style="font-size: 0.8em; padding: 4px 8px; background: #38a169;">‚ñ∂Ô∏è Start Session</button>
                            </div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        async function scanForH10Devices() {
            const scanningDiv = document.getElementById('h10-scanning');
            scanningDiv.style.display = 'block';

            try {
                // Note: This is a placeholder for actual Bluetooth scanning
                // In a real implementation, you would use Web Bluetooth API
                setTimeout(() => {
                    scanningDiv.style.display = 'none';
                    alert('Bluetooth scanning requires HTTPS and user permission.\n\nTo manually find your H10:\n1. Check the device label on your H10\n2. Look for "Polar H10 XXXXXXXX" in Bluetooth settings\n3. The device ID is usually the full name including numbers');
                }, 2000);
            } catch (error) {
                scanningDiv.style.display = 'none';
                alert('Bluetooth scanning not available in this browser. Please enter device ID manually.');
            }
        }

        function testH10Connection(participantId) {
            const participant = participants.find(p => p.id === participantId);
            if (!participant) return;

            // Simulate connection test
            alert(`Testing connection to ${participant.deviceId}...\n\nThis is a simulation. In a real implementation:\n1. Check Bluetooth connectivity\n2. Verify heart rate signal\n3. Test data transmission\n4. Update connection status`);
            
            // Simulate random connection status for demo
            participant.connected = Math.random() > 0.5;
            participant.lastSeen = new Date().toISOString();
            saveParticipants();
            renderParticipants();
        }

        function startH10Session(participantId) {
            const participant = participants.find(p => p.id === participantId);
            if (!participant) return;

            alert(`Starting meditation session for ${participant.name} (${participant.id})\n\nIn a real implementation, this would:\n1. Connect to ${participant.deviceId}\n2. Start heart rate monitoring\n3. Begin data logging\n4. Prepare for meditation guidance`);
        }

        function exportParticipants() {
            const dataStr = JSON.stringify(participants, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `h10_participants_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
        }

        function importParticipants() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        if (Array.isArray(importedData)) {
                            participants = importedData;
                            saveParticipants();
                            renderParticipants();
                            alert(`Successfully imported ${participants.length} participants!`);
                        } else {
                            alert('Invalid file format. Please select a valid participant export file.');
                        }
                    } catch (error) {
                        alert('Error reading file: ' + error.message);
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        // Auto-format participant ID to uppercase and initialize H10 section
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing H10 participant management'); // Debug log
            
            const participantIdInput = document.getElementById('participant-id');
            if (participantIdInput) {
                participantIdInput.addEventListener('input', function() {
                    this.value = this.value.toUpperCase();
                });
                console.log('Participant ID input found and event listener added'); // Debug log
            } else {
                console.error('Participant ID input not found!'); // Debug log
            }
            
            // Render participants on page load
            renderParticipants();
        });

        // Button feedback and interaction enhancements
        function addButtonFeedback() {
            const buttons = document.querySelectorAll('.btn');
            
            buttons.forEach(button => {
                // Add click ripple effect
                button.addEventListener('click', function(e) {
                    // Only add ripple if not disabled or loading
                    if (this.disabled || this.classList.contains('loading')) return;
                    
                    const ripple = document.createElement('span');
                    const rect = this.getBoundingClientRect();
                    const size = Math.max(rect.width, rect.height);
                    const x = e.clientX - rect.left - size / 2;
                    const y = e.clientY - rect.top - size / 2;
                    
                    ripple.style.cssText = `
                        position: absolute;
                        width: ${size}px;
                        height: ${size}px;
                        left: ${x}px;
                        top: ${y}px;
                        background: rgba(255, 255, 255, 0.3);
                        border-radius: 50%;
                        transform: scale(0);
                        animation: ripple 0.6s linear;
                        pointer-events: none;
                        z-index: 0;
                    `;
                    
                    this.appendChild(ripple);
                    
                    setTimeout(() => {
                        ripple.remove();
                    }, 600);
                });
                
                // Add touch feedback for mobile
                button.addEventListener('touchstart', function() {
                    if (!this.disabled && !this.classList.contains('loading')) {
                        this.style.transform = 'translateY(0px) scale(0.98)';
                    }
                });
                
                button.addEventListener('touchend', function() {
                    if (!this.disabled && !this.classList.contains('loading')) {
                        setTimeout(() => {
                            this.style.transform = '';
                        }, 100);
                    }
                });
            });
        }

        // Utility functions for button states
        function setButtonLoading(buttonElement, loadingText = 'Loading...') {
            if (!buttonElement) return;
            
            buttonElement.dataset.originalText = buttonElement.textContent;
            buttonElement.classList.add('loading');
            buttonElement.disabled = true;
            buttonElement.textContent = loadingText;
        }

        function clearButtonLoading(buttonElement) {
            if (!buttonElement) return;
            
            buttonElement.classList.remove('loading');
            buttonElement.disabled = false;
            buttonElement.textContent = buttonElement.dataset.originalText || buttonElement.textContent;
        }

        function showButtonSuccess(buttonElement, successText = 'Success!', duration = 2000) {
            if (!buttonElement) return;
            
            const originalText = buttonElement.textContent;
            const originalClass = buttonElement.className;
            
            buttonElement.textContent = successText;
            buttonElement.className = originalClass.replace(/btn-\w+/g, '') + ' btn-secondary';
            
            setTimeout(() => {
                buttonElement.textContent = originalText;
                buttonElement.className = originalClass;
            }, duration);
        }

        function showButtonError(buttonElement, errorText = 'Error!', duration = 2000) {
            if (!buttonElement) return;
            
            const originalText = buttonElement.textContent;
            const originalClass = buttonElement.className;
            
            buttonElement.textContent = errorText;
            buttonElement.className = originalClass.replace(/btn-\w+/g, '') + ' btn-danger';
            
            setTimeout(() => {
                buttonElement.textContent = originalText;
                buttonElement.className = originalClass;
            }, duration);
        }

        // Enhanced function wrappers for existing functionality
        function enhancedGenerateEntrainmentMeditation() {
            const button = event.target;
            setButtonLoading(button, 'Generating...');
            
            generateEntrainmentMeditation().then(() => {
                showButtonSuccess(button, 'Generated!');
            }).catch(() => {
                showButtonError(button, 'Failed!');
            }).finally(() => {
                setTimeout(() => clearButtonLoading(button), 2000);
            });
        }

        function enhancedGenerateEntrainmentWithTTS() {
            const button = event.target;
            setButtonLoading(button, 'Creating Audio...');
            
            generateEntrainmentWithTTS().then(() => {
                showButtonSuccess(button, 'Audio Ready!');
            }).catch(() => {
                showButtonError(button, 'Audio Failed!');
            }).finally(() => {
                setTimeout(() => clearButtonLoading(button), 2000);
            });
        }

        // Add ripple animation CSS
        const rippleStyle = document.createElement('style');
        rippleStyle.textContent = `
            @keyframes ripple {
                0% { transform: scale(0); opacity: 1; }
                100% { transform: scale(4); opacity: 0; }
            }
        `;
        document.head.appendChild(rippleStyle);

        // Load on page load
        loadConfig();
        loadStats();
        loadFeedbackStats();
        renderParticipants(); // Load participants on page load
        
        // Initialize button feedback after DOM is ready
        setTimeout(addButtonFeedback, 100);
        
        setInterval(loadStats, 10000); // Refresh stats every 10 seconds
        setInterval(loadFeedbackStats, 30000); // Refresh feedback every 30 seconds
    </script>

    <!-- Feedback Modal -->
    <div id="feedback-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
        <div style="background: white; padding: 30px; border-radius: 12px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto;">
            <h3 style="margin-bottom: 20px; color: #667eea;">Rate Your Meditation Experience</h3>
            <form id="feedback-form">
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">1. Relevance to Environment (1-10)</label>
                    <input type="range" id="rating-relevance" min="1" max="10" value="5" style="width: 100%;">
                    <span id="relevance-value" style="font-size: 0.9em; color: #666;">5</span>
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">2. Emotional Groundedness (1-10)</label>
                    <input type="range" id="rating-groundedness" min="1" max="10" value="5" style="width: 100%;">
                    <span id="groundedness-value" style="font-size: 0.9em; color: #666;">5</span>
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">3. Engagement with Nature (1-10)</label>
                    <input type="range" id="rating-engagement" min="1" max="10" value="5" style="width: 100%;">
                    <span id="engagement-value" style="font-size: 0.9em; color: #666;">5</span>
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">4. Audio/TTS Quality (1-10)</label>
                    <input type="range" id="rating-tts" min="1" max="10" value="5" style="width: 100%;">
                    <span id="tts-value" style="font-size: 0.9em; color: #666;">5</span>
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">5. Overall Satisfaction (1-10)</label>
                    <input type="range" id="rating-overall" min="1" max="10" value="5" style="width: 100%;">
                    <span id="overall-value" style="font-size: 0.9em; color: #666;">5</span>
                </div>
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Comments (Optional)</label>
                    <textarea id="feedback-comments" rows="3" style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #ddd;" placeholder="What stood out or could be improved?"></textarea>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button type="button" onclick="submitFeedback()" class="btn" style="flex: 1;">Submit Feedback</button>
                    <button type="button" onclick="closeFeedbackModal()" class="btn btn-secondary" style="flex: 1;">Cancel</button>
                </div>
            </form>
        </div>
    </div>
</body>
</html>
