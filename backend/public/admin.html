<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Momentus Admin Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            color: white;
            margin-bottom: 30px;
            font-size: 2.5em;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }

        .card h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .provider-card {
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .provider-card:hover {
            border-color: #667eea;
            transform: translateY(-2px);
        }

        .provider-card.active {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .model-select {
            width: 100%;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #ddd;
            font-size: 14px;
            margin-top: 10px;
        }

        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn:hover {
            background: #5568d3;
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: #48bb78;
        }

        .btn-secondary:hover {
            background: #38a169;
        }

        .status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .status.active {
            background: #c6f6d5;
            color: #22543d;
        }

        .status.inactive {
            background: #fed7d7;
            color: #742a2a;
        }

        .stat-box {
            text-align: center;
            padding: 15px;
            background: #f7fafc;
            border-radius: 8px;
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            color: #718096;
            font-size: 0.9em;
            margin-top: 5px;
        }

        .test-result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 6px;
            background: #f7fafc;
        }

        .test-result.success {
            background: #c6f6d5;
            color: #22543d;
        }

        .test-result.error {
            background: #fed7d7;
            color: #742a2a;
        }

        .meditation-preview {
            background: #f7fafc;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            white-space: pre-wrap;
            font-family: Georgia, serif;
            line-height: 1.8;
            max-height: 400px;
            overflow-y: auto;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 8px;
        }

        .badge.fast { background: #c6f6d5; color: #22543d; }
        .badge.medium { background: #feebc8; color: #7c2d12; }
        .badge.high { background: #bee3f8; color: #2c5282; }

        .species-summary {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .species-category {
            margin-bottom: 20px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .species-category h4 {
            margin: 0 0 10px 0;
            color: #667eea;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .species-count {
            background: #667eea;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
        }

        .species-list {
            max-height: 150px;
            overflow-y: auto;
        }

        .species-item {
            padding: 5px 0;
            border-bottom: 1px solid #e2e8f0;
            font-size: 14px;
        }

        .species-item:last-child {
            border-bottom: none;
        }

        .species-name {
            font-weight: 600;
            color: #2d3748;
        }

        .species-scientific {
            color: #718096;
            font-style: italic;
        }

        .species-source {
            float: right;
            font-size: 11px;
            background: #e2e8f0;
            padding: 1px 6px;
            border-radius: 10px;
            color: #4a5568;
        }

        .source-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .source-stat {
            text-align: center;
            padding: 10px;
            background: white;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
        }

        .source-stat.error {
            background: #fed7d7;
            border-color: #feb2b2;
        }

        .source-stat-number {
            font-size: 18px;
            font-weight: 600;
            color: #667eea;
        }

        .source-stat.error .source-stat-number {
            color: #e53e3e;
        }

        .source-stat-label {
            font-size: 12px;
            color: #718096;
            margin-top: 2px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🧘 Momentus Admin Dashboard</h1>

        <!-- Current Configuration -->
        <div class="card">
            <h2>Current AI Configuration</h2>
            <div id="current-config">
                <p>Loading...</p>
            </div>
        </div>

        <!-- AI Provider Selection -->
        <div class="card">
            <h2>AI Provider & Model Selection</h2>
            <div class="grid">
                <div class="provider-card" id="provider-google" onclick="selectProvider('google')">
                    <h3>🤖 Google Gemini <span class="status" id="status-google">Checking...</span></h3>
                    <select class="model-select" id="model-google" onchange="updateModel('google', this.value)">
                        <option value="gemini-2.0-flash-exp">Gemini Pro <span class="badge medium">Balanced</span> <span class="badge high">High Quality</span></option>
                        <option value="gemini-1.5-flash">Gemini 1.5 Flash <span class="badge fast">Fast</span></option>
                        <option value="gemini-2.0-flash-exp">Gemini 2.0 Flash (Exp) <span class="badge fast">Very Fast</span></option>
                    </select>
                    <button class="btn" onclick="testProvider('google')" style="margin-top: 10px; width: 100%;">Test Provider</button>
                    <div id="test-result-google"></div>
                </div>

                <div class="provider-card" id="provider-anthropic" onclick="selectProvider('anthropic')">
                    <h3>🧠 Anthropic Claude <span class="status" id="status-anthropic">Checking...</span></h3>
                    <select class="model-select" id="model-anthropic" onchange="updateModel('anthropic', this.value)">
                        <option value="claude-3-opus-20240229">Claude 3 Opus <span class="badge medium">Slow</span> <span class="badge high">Highest Quality</span></option>
                        <option value="claude-3-sonnet-20240229">Claude 3 Sonnet <span class="badge fast">Fast</span> <span class="badge high">Good</span></option>
                        <option value="claude-3-haiku-20240307">Claude 3 Haiku <span class="badge fast">Very Fast</span></option>
                    </select>
                    <button class="btn" onclick="testProvider('anthropic')" style="margin-top: 10px; width: 100%;">Test Provider</button>
                    <div id="test-result-anthropic"></div>
                </div>
            </div>
            <div style="margin-top: 20px;">
                <button class="btn btn-secondary" onclick="saveConfiguration()">💾 Save Configuration</button>
            </div>
        </div>

        <!-- Test Meditation Generation -->
        <div class="card">
            <h2>Test Meditation Generation</h2>
            <div class="grid" style="grid-template-columns: 1fr 1fr;">
                <div>
                    <label>Latitude:</label>
                    <input type="number" id="test-lat" value="34.0522" step="0.0001" style="width: 100%; padding: 8px; margin: 5px 0; border-radius: 4px; border: 1px solid #ddd;">
                    <label>Longitude:</label>
                    <input type="number" id="test-lng" value="-117.2437" step="0.0001" style="width: 100%; padding: 8px; margin: 5px 0; border-radius: 4px; border: 1px solid #ddd;">
                    <button class="btn" onclick="testMeditation()" style="margin-top: 10px; width: 100%;">Generate Test Meditation</button>
                    <button class="btn" onclick="generateTwice()" style="margin-top: 10px; width: 100%; background: #4c51bf;">Generate Twice</button>
                    <button class="btn" onclick="showFeedbackModal()" style="margin-top: 10px; width: 100%; background: #28a745;">⭐ Rate Meditation</button>
                </div>
                <div id="meditation-output">
                    <p style="color: #718096;">Click "Generate Test Meditation" to preview</p>
                </div>
            </div>
        </div>

        <!-- Species in My Area -->
        <div class="card">
            <h2>🌍 Species in My Area</h2>
            <p style="color: #718096; margin-bottom: 15px;">Discover real species in your current location using live data from iNaturalist, GBIF, and eBird. No fallback data included.</p>
            <div class="grid" style="grid-template-columns: 1fr 2fr;">
                <div>
                    <button class="btn" onclick="getMyLocationSpecies()" style="width: 100%; margin-bottom: 10px;">📍 Species in My Area</button>
                    <div style="font-size: 0.9em; color: #718096; margin-bottom: 10px;">Or enter coordinates manually:</div>
                    <label>Latitude:</label>
                    <input type="number" id="my-area-lat" value="" step="0.0001" style="width: 100%; padding: 8px; margin: 5px 0; border-radius: 4px; border: 1px solid #ddd;">
                    <label>Longitude:</label>
                    <input type="number" id="my-area-lng" value="" step="0.0001" style="width: 100%; padding: 8px; margin: 5px 0; border-radius: 4px; border: 1px solid #ddd;">
                    <button class="btn" onclick="getAreaSpecies()" style="margin-top: 10px; width: 100%;">🔍 Search Area</button>
                    <div id="area-loading" style="display: none; margin-top: 10px; color: #667eea;">
                        <div class="loading"></div> Finding species...
                    </div>
                </div>
                <div id="area-results">
                    <p style="color: #718096;">Click "Species in My Area" to automatically detect your location, or enter coordinates manually</p>
                </div>
            </div>
        </div>

        <!-- Robust Species Testing with Error Monitoring -->
        <div class="card">
            <h2>🧬 Robust Species Testing</h2>
            <p style="color: #718096; margin-bottom: 15px;">Test the new robust species system with guaranteed results. All 6 animal classes should NEVER return 0 results.</p>
            <div class="grid" style="grid-template-columns: 1fr 2fr;">
                <div>
                    <label>Species No-Repeat Days:</label>
                    <input type="number" id="species-no-repeat-days" value="2" min="0" step="1" style="width: 100%; padding: 8px; margin: 5px 0; border-radius: 4px; border: 1px solid #ddd;">
                    <button class="btn" onclick="saveSpeciesConfig()" style="margin-top: 8px; width: 100%;">Save Species Config</button>

                    <label>Test Coordinates:</label>
                    <input type="number" id="species-test-lat" value="33.9425" step="0.0001" placeholder="Latitude" style="width: 100%; padding: 8px; margin: 5px 0; border-radius: 4px; border: 1px solid #ddd;">
                    <input type="number" id="species-test-lng" value="-117.3917" step="0.0001" placeholder="Longitude" style="width: 100%; padding: 8px; margin: 5px 0; border-radius: 4px; border: 1px solid #ddd;">
                    <button class="btn" onclick="testSpeciesRobustness()" style="margin-top: 10px; width: 100%;">🔬 Test System Robustness</button>
                    <div style="margin-top: 15px; padding: 12px; background: #fff5f5; border: 1px solid #feb2b2; border-radius: 6px; font-size: 0.9em;">
                        <div style="color: #c53030; font-weight: bold; margin-bottom: 5px;">⚠️ Zero Results Alert</div>
                        <div style="color: #718096;">Any species class returning 0 results indicates a critical system failure that requires immediate attention.</div>
                    </div>
                    <div id="robust-loading" style="display: none; margin-top: 10px; color: #667eea;">
                        <div class="loading"></div> Testing robustness...
                    </div>
                </div>
                <div id="robust-results">
                    <p style="color: #718096;">Test the robust species system to verify all 6 animal classes return results with comprehensive GBIF → Regional → Global fallbacks.</p>
                </div>
            </div>
        </div>

        <!-- System Statistics -->
        <div class="card">
            <h2>System Statistics</h2>
            <div class="grid">
                <div class="stat-box">
                    <div class="stat-number" id="stat-sessions">-</div>
                    <div class="stat-label">Active Sessions</div>
                </div>
                <div class="stat-box">
                    <div class="stat-number" id="stat-lunar">-</div>
                    <div class="stat-label">Current Lunar Day</div>
                </div>
                <div class="stat-box">
                    <div class="stat-number" id="stat-behaviors">21</div>
                    <div class="stat-label">Behavior Patterns</div>
                </div>
                <div class="stat-box">
                    <div class="stat-number" id="stat-species">5</div>
                    <div class="stat-label">Species Types</div>
                </div>
                <div class="stat-box">
                    <div class="stat-number" id="stat-gbif-circuit">—</div>
                    <div class="stat-label">GBIF Circuit</div>
                </div>
                <div style="text-align:center;">
                    <div id="gbif-circuit-countdown" style="color:#718096; font-size:12px; margin-top:6px;">&nbsp;</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Feedback Analytics -->
    <div class="card">
        <h2>📊 Feedback Analytics</h2>
        <div class="grid">
            <div class="stat-box">
                <div class="stat-number" id="feedback-total">-</div>
                <div class="stat-label">Total Feedback</div>
            </div>
            <div class="stat-box">
                <div class="stat-number" id="feedback-recent">-</div>
                <div class="stat-label">Recent (24h)</div>
            </div>
            <div class="stat-box">
                <div class="stat-number" id="feedback-avg-overall">-</div>
                <div class="stat-label">Avg Overall</div>
            </div>
            <div class="stat-box">
                <div class="stat-number" id="feedback-avg-engagement">-</div>
                <div class="stat-label">Avg Engagement</div>
            </div>
        </div>
        <div style="margin-top: 20px;">
            <h3 style="color: #667eea; margin-bottom: 10px;">Rating Averages (1-10)</h3>
            <div id="feedback-ratings-chart" style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px;">
                <!-- Rating bars will be inserted here -->
            </div>
            <div id="feedback-insights" style="background: #f7fafc; padding: 12px; border-radius: 6px; border-left: 4px solid #667eea;">
                <strong>AI Insights:</strong> <span id="insights-text">Loading...</span>
            </div>
            <div id="feedback-adjustments" style="margin-top: 15px;">
                <h4 style="color: #667eea; margin-bottom: 8px;">Current AI Adjustments</h4>
                <div id="adjustments-list" style="background: #fffaf0; padding: 10px; border-radius: 4px; font-size: 0.9em;">
                    <!-- Adjustments will be listed here -->
                </div>
            </div>
        </div>
        <button class="btn" onclick="loadFeedbackStats()" style="margin-top: 15px;">🔄 Refresh Analytics</button>
    </div>

    <script>
        let currentProvider = 'google';
        let currentModel = 'gemini-1.5-pro';

        async function loadConfig() {
            try {
                const res = await fetch('/api/admin/ai-config');
                const data = await res.json();

                if (data.success) {
                    currentProvider = data.config.provider;
                    currentModel = data.config.model;

                    document.getElementById('current-config').innerHTML = `
                        <p><strong>Provider:</strong> ${data.config.provider}</p>
                        <p><strong>Model:</strong> ${data.config.model}</p>
                        <p><strong>Google AI:</strong> <span class="status ${data.config.providersInitialized.google ? 'active' : 'inactive'}">${data.config.providersInitialized.google ? 'Active' : 'Inactive'}</span></p>
                        <p><strong>Claude AI:</strong> <span class="status ${data.config.providersInitialized.anthropic ? 'active' : 'inactive'}">${data.config.providersInitialized.anthropic ? 'Active' : 'Inactive'}</span></p>
                    `;

                    document.getElementById('status-google').className = 'status ' + (data.config.providersInitialized.google ? 'active' : 'inactive');
                    document.getElementById('status-google').textContent = data.config.providersInitialized.google ? 'Active' : 'Inactive';

                    document.getElementById('status-anthropic').className = 'status ' + (data.config.providersInitialized.anthropic ? 'active' : 'inactive');
                    document.getElementById('status-anthropic').textContent = data.config.providersInitialized.anthropic ? 'Active' : 'Inactive';

                    selectProvider(currentProvider);
                    document.getElementById('model-' + currentProvider).value = currentModel;
                }
            } catch (error) {
                console.error('Failed to load config:', error);
            }
        }

        // Load runtime species configuration and populate the UI
        async function loadSpeciesConfig() {
            try {
                const res = await fetch('/api/admin/species-config');
                const data = await res.json();
                if (data.success && data.config) {
                    document.getElementById('species-no-repeat-days').value = data.config.noRepeatDays;
                }
            } catch (err) {
                console.warn('Failed to load species config', err);
            }
        }

        async function saveSpeciesConfig() {
            const val = document.getElementById('species-no-repeat-days').value;
            try {
                const res = await fetch('/api/admin/species-config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ noRepeatDays: Number(val) })
                });
                const data = await res.json();
                if (data.success) {
                    alert('Species configuration updated: noRepeatDays = ' + data.config.noRepeatDays);
                    // refresh stats to reflect change
                    loadStats();
                } else {
                    alert('Failed to update species configuration: ' + (data.error || 'unknown'));
                }
            } catch (err) {
                alert('Error saving species configuration: ' + err.message);
            }
        }

        async function loadStats() {
            try {
                const res = await fetch('/api/admin/stats');
                const data = await res.json();

                if (data.success) {
                    document.getElementById('stat-sessions').textContent = data.stats.session.activeSessions;
                    document.getElementById('stat-lunar').textContent = data.stats.session.lunarStats?.currentLunarDay || '-';
                    // GBIF circuit status
                    const gbifCircuit = data.stats.session.speciesStats?.gbifCircuit || data.stats.session.speciesStats || data.stats.session.gbifCircuit || null;
                    if (gbifCircuit) {
                        document.getElementById('stat-gbif-circuit').textContent = gbifCircuit.open ? 'OPEN' : 'CLOSED';
                        document.getElementById('stat-gbif-circuit').style.color = gbifCircuit.open ? '#e53e3e' : '#2f855a';
                        // Update countdown if open
                        if (gbifCircuit.open && gbifCircuit.openUntil) {
                            startGbifCountdown(gbifCircuit.openUntil);
                        } else {
                            stopGbifCountdown();
                        }
                    }
                }
            } catch (error) {
                console.error('Failed to load stats:', error);
            }
        }

        // Load feedback analytics
        async function loadFeedbackStats() {
            try {
                const res = await fetch('/api/admin/feedback-stats');
                const data = await res.json();

                if (data.success) {
                    const stats = data.stats;
                    const analysis = stats.recentAnalysis;

                    // Update basic stats
                    document.getElementById('feedback-total').textContent = stats.totalEntries;
                    document.getElementById('feedback-recent').textContent = analysis.sampleSize;
                    document.getElementById('feedback-avg-overall').textContent = analysis.averages.overall.toFixed(1);
                    document.getElementById('feedback-avg-engagement').textContent = analysis.averages.engagement.toFixed(1);

                    // Create rating bars chart
                    const chartContainer = document.getElementById('feedback-ratings-chart');
                    chartContainer.innerHTML = '';

                    const dimensions = [
                        { key: 'relevance', label: 'Relevance', color: '#667eea' },
                        { key: 'groundedness', label: 'Groundedness', color: '#48bb78' },
                        { key: 'engagement', label: 'Engagement', color: '#ed8936' },
                        { key: 'ttsQuality', label: 'TTS Quality', color: '#9f7aea' },
                        { key: 'overall', label: 'Overall', color: '#e53e3e' }
                    ];

                    dimensions.forEach(dim => {
                        const value = analysis.averages[dim.key];
                        const percentage = (value / 10) * 100;

                        const bar = document.createElement('div');
                        bar.style.cssText = `
                            flex: 1;
                            min-width: 120px;
                            text-align: center;
                        `;

                        bar.innerHTML = `
                            <div style="font-size: 0.8em; color: #666; margin-bottom: 5px;">${dim.label}</div>
                            <div style="background: #e2e8f0; height: 20px; border-radius: 10px; overflow: hidden; margin-bottom: 5px;">
                                <div style="background: ${dim.color}; height: 100%; width: ${percentage}%; border-radius: 10px; transition: width 0.3s ease;"></div>
                            </div>
                            <div style="font-weight: bold; color: ${dim.color};">${value.toFixed(1)}</div>
                        `;

                        chartContainer.appendChild(bar);
                    });

                    // Update insights
                    document.getElementById('insights-text').textContent = analysis.insights;

                    // Update adjustments
                    const adjustmentsList = document.getElementById('adjustments-list');
                    adjustmentsList.innerHTML = '';

                    if (Object.keys(analysis.adjustments).length === 0) {
                        adjustmentsList.innerHTML = '<em>No adjustments needed - ratings are strong!</em>';
                    } else {
                        Object.entries(analysis.adjustments).forEach(([key, adjustment]) => {
                            const item = document.createElement('div');
                            item.style.cssText = `
                                margin-bottom: 8px;
                                padding: 6px;
                                background: ${adjustment.priority === 'high' ? '#fed7d7' : adjustment.priority === 'medium' ? '#fef5e7' : '#f0fff4'};
                                border-radius: 4px;
                                border-left: 3px solid ${adjustment.priority === 'high' ? '#e53e3e' : adjustment.priority === 'medium' ? '#ed8936' : '#38a169'};
                            `;

                            item.innerHTML = `
                                <strong>${key.charAt(0).toUpperCase() + key.slice(1)} (${adjustment.priority} priority):</strong>
                                <ul style="margin: 4px 0 0 16px; padding: 0;">
                                    ${adjustment.suggestions.map(s => `<li style="margin: 2px 0;">${s}</li>`).join('')}
                                </ul>
                            `;

                            adjustmentsList.appendChild(item);
                        });
                    }
                }
            } catch (error) {
                console.error('Failed to load feedback stats:', error);
                document.getElementById('insights-text').textContent = 'Error loading analytics';
            }
        }

        // Countdown for GBIF circuit openUntil (ms since epoch)
        let _gbifCountdownInterval = null;
        function startGbifCountdown(openUntilMs) {
            stopGbifCountdown();
            function tick() {
                const now = Date.now();
                const delta = openUntilMs - now;
                const el = document.getElementById('gbif-circuit-countdown');
                if (!el) return;
                if (delta <= 0) {
                    el.textContent = 'Circuit will close shortly';
                    stopGbifCountdown();
                    return;
                }
                const secs = Math.floor(delta / 1000);
                const mins = Math.floor(secs / 60);
                const rem = secs % 60;
                el.textContent = `Closes in ${mins}m ${rem}s`;
            }
            tick();
            _gbifCountdownInterval = setInterval(tick, 1000);
        }

        function stopGbifCountdown() {
            if (_gbifCountdownInterval) {
                clearInterval(_gbifCountdownInterval);
                _gbifCountdownInterval = null;
            }
            const el = document.getElementById('gbif-circuit-countdown');
            if (el) el.textContent = '';
        }

        // Helper to escape HTML for safe rendering of raw snippets
        function escapeHtml(unsafe) {
            if (!unsafe) return '';
            return unsafe
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }

        function selectProvider(provider) {
            currentProvider = provider;
            document.querySelectorAll('.provider-card').forEach(card => {
                card.classList.remove('active');
            });
            document.getElementById('provider-' + provider).classList.add('active');
        }

        function updateModel(provider, model) {
            if (provider === currentProvider) {
                currentModel = model;
            }
        }

        async function testProvider(provider) {
            const model = document.getElementById('model-' + provider).value;
            const resultDiv = document.getElementById('test-result-' + provider);

            resultDiv.innerHTML = '<div class="test-result"><span class="loading"></span> Testing...</div>';

            try {
                const res = await fetch('/api/admin/test-ai', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ provider, model })
                });

                const data = await res.json();

                if (data.result.success) {
                    resultDiv.innerHTML = `
                        <div class="test-result success">
                            ✅ Success! Response: ${data.result.responseLength} chars<br>
                            Tokens: ${data.result.usage.totalTokens}
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="test-result error">
                            ❌ Failed: ${data.result.error}
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="test-result error">❌ Error: ${error.message}</div>`;
            }
        }

        async function saveConfiguration() {
            try {
                const res = await fetch('/api/admin/ai-config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        provider: currentProvider,
                        model: currentModel
                    })
                });

                const data = await res.json();

                if (data.success) {
                    alert('✅ Configuration saved successfully!');
                    loadConfig();
                } else {
                    alert('❌ Failed to save configuration: ' + data.error);
                }
            } catch (error) {
                alert('❌ Error: ' + error.message);
            }
        }

        async function testMeditation() {
            const lat = document.getElementById('test-lat').value;
            const lng = document.getElementById('test-lng').value;
            const outputDiv = document.getElementById('meditation-output');

            outputDiv.innerHTML = '<div class="loading"></div> Generating meditation...';

            try {
                const res = await fetch('/api/admin/test-meditation', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        latitude: parseFloat(lat),
                        longitude: parseFloat(lng),
                        provider: currentProvider,
                        model: currentModel
                    })
                });

                const data = await res.json();

                if (data.success) {
                    outputDiv.innerHTML = `
                        <div class="meditation-preview">${data.session.content.text}</div>
                        <p style="margin-top: 10px; color: #718096;">
                            Species: ${data.session.species.name} |
                            Lunar: Day ${data.session.lunar.day} (${data.session.lunar.phase}) |
                            Duration: ${data.session.content.duration}s
                        </p>
                    `;
                } else {
                    outputDiv.innerHTML = '<div class="test-result error">Failed to generate meditation</div>';
                }
            } catch (error) {
                outputDiv.innerHTML = '<div class="test-result error">Error: ' + error.message + '</div>';
            }
        }

        // Generate two meditations in a row and show them side-by-side for comparison
        async function generateTwice() {
            const lat = document.getElementById('test-lat').value;
            const lng = document.getElementById('test-lng').value;
            const outputDiv = document.getElementById('meditation-output');

            outputDiv.innerHTML = '<div class="loading"></div> Generating two meditations...';

            try {
                const payload = {
                    latitude: parseFloat(lat),
                    longitude: parseFloat(lng),
                    provider: currentProvider,
                    model: currentModel
                };

                // Run sequentially to make behavior deterministic for repeat/no-repeat testing
                const results = [];
                for (let i = 0; i < 2; i++) {
                    const res = await fetch('/api/admin/test-meditation', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    const data = await res.json();
                    if (!data || !data.success) {
                        throw new Error((data && data.error) || 'Failed to generate meditation');
                    }
                    results.push(data.session);
                }

                // Helper to escape regex chars
                function escapeRegExp(string) {
                    return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                }

                // Build comparison UI
                const left = results[0];
                const right = results[1];

                const leftSpecies = left.species?.name || '—';
                const rightSpecies = right.species?.name || '—';

                // Highlight species name occurrences inside the meditation text (case-insensitive)
                function highlightSpecies(text, speciesName) {
                    if (!speciesName) return escapeHtml(text);
                    const escaped = escapeRegExp(speciesName);
                    try {
                        const re = new RegExp('(' + escaped + ')', 'ig');
                        return escapeHtml(text).replace(re, '<mark>$1</mark>');
                    } catch (e) {
                        return escapeHtml(text);
                    }
                }

                const html = `
                    <div style="display:flex; gap:12px; align-items:flex-start;">
                        <div style="flex:1;">
                            <div class="meditation-preview">${highlightSpecies(left.content.text || '', leftSpecies)}</div>
                            <p style="margin-top:8px; color:#718096; font-size:0.95em;">Species: <strong>${escapeHtml(leftSpecies)}</strong> | Lunar: ${escapeHtml(String(left.lunar?.phase || ''))} | Duration: ${escapeHtml(String(left.content?.duration || ''))}s</p>
                        </div>
                        <div style="flex:1;">
                            <div class="meditation-preview">${highlightSpecies(right.content.text || '', rightSpecies)}</div>
                            <p style="margin-top:8px; color:#718096; font-size:0.95em;">Species: <strong>${escapeHtml(rightSpecies)}</strong> | Lunar: ${escapeHtml(String(right.lunar?.phase || ''))} | Duration: ${escapeHtml(String(right.content?.duration || ''))}s</p>
                        </div>
                    </div>
                    <div style="margin-top:10px;">
                        <strong>Comparison:</strong> ${escapeHtml(leftSpecies) === escapeHtml(rightSpecies) ? '<span style="color:#2f855a;">Same species selected</span>' : '<span style="color:#dd6b20;">Different species selected</span>'}
                    </div>
                `;

                outputDiv.innerHTML = html;

            } catch (error) {
                outputDiv.innerHTML = '<div class="test-result error">Error: ' + escapeHtml(error.message || String(error)) + '</div>';
            }
        }

        async function getMyLocationSpecies() {
            const loadingEl = document.getElementById('area-loading');
            const resultsEl = document.getElementById('area-results');

            if (!navigator.geolocation) {
                alert('Geolocation is not supported by this browser');
                return;
            }

            loadingEl.style.display = 'block';
            resultsEl.innerHTML = '';

            navigator.geolocation.getCurrentPosition(
                async (position) => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    
                    // Update input fields
                    document.getElementById('my-area-lat').value = lat.toFixed(6);
                    document.getElementById('my-area-lng').value = lng.toFixed(6);
                    
                    await testSpeciesAtLocation(lat, lng, loadingEl, resultsEl);
                },
                (error) => {
                    loadingEl.style.display = 'none';
                    let errorMsg = 'Unable to get location: ';
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMsg += 'Location access denied by user.';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMsg += 'Location information unavailable.';
                            break;
                        case error.TIMEOUT:
                            errorMsg += 'Location request timed out.';
                            break;
                    }
                    resultsEl.innerHTML = `<div style="color: #e53e3e; padding: 10px; background: #fed7d7; border-radius: 4px;">${errorMsg}</div>`;
                }
            );
        }

        async function getAreaSpecies() {
            const lat = document.getElementById('my-area-lat').value;
            const lng = document.getElementById('my-area-lng').value;
            const loadingEl = document.getElementById('area-loading');
            const resultsEl = document.getElementById('area-results');

            if (!lat || !lng) {
                alert('Please enter both latitude and longitude or use "Species in My Area" for automatic detection');
                return;
            }

            // Use the new robust species testing
            await testSpeciesAtLocation(parseFloat(lat), parseFloat(lng), loadingEl, resultsEl);
        }

        // New function that uses robust species testing  
        async function testSpeciesAtLocation(lat, lng, loadingEl, resultsEl) {
            loadingEl.style.display = 'block';
            resultsEl.innerHTML = '';

            try {
                const response = await fetch('/api/admin/test-species', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ latitude: lat, longitude: lng })
                });

                const data = await response.json();

                if (data.success) {
                    let html = `
                        <div style="margin-bottom: 15px; padding: 10px; background: ${data.summary.hasZeroResults ? '#fff5f5' : '#f0fff4'}; border-radius: 6px;">
                            <div style="color: ${data.summary.hasZeroResults ? '#c53030' : '#38a169'}; font-weight: bold;">
                                ${data.summary.hasZeroResults ? '❌ SYSTEM ISSUES' : '✅ SYSTEM HEALTHY'}
                            </div>
                            <div style="color: #718096; margin-top: 5px;">
                                📍 ${lat.toFixed(4)}, ${lng.toFixed(4)} | 
                                ${data.summary.successfulClasses}/${data.summary.totalClasses} classes returned species
                            </div>
                        </div>
                    `;

                    // Show GBIF diagnostic if present
                    if (data.gbifDiagnostic) {
                        html += `
                            <div style="margin-top:12px; padding:10px; background:#fffaf0; border-radius:6px; border:1px solid #f6e05e;">
                                <strong style="color:#744210;">GBIF Diagnostic:</strong>
                                <div style="color:#744210; font-size:0.9em; margin-top:6px;">${escapeHtml(data.gbifDiagnostic.message || '')}</div>
                                ${data.gbifDiagnostic.rawSnippet ? `<pre style="background:#fff; padding:8px; border-radius:4px; overflow:auto; margin-top:6px;">${escapeHtml(data.gbifDiagnostic.rawSnippet)}</pre>` : ''}
                            </div>
                        `;
                    }

                    data.results.forEach(result => {
                        const isHealthy = result.count > 0;
                        const statusColor = isHealthy ? '#38a169' : '#c53030';
                        const bgColor = isHealthy ? '#f0fff4' : '#fff5f5';

                        html += `
                            <div style="margin-bottom: 10px; padding: 12px; background: ${bgColor}; border-radius: 6px; border-left: 4px solid ${statusColor};">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                    <h4 style="margin: 0; color: #2d3748;">${result.class}</h4>
                                    <span style="color: ${statusColor}; font-weight: bold;">
                                        ${isHealthy ? '✅ ' + result.count + ' species' : '❌ NO RESULTS'}
                                    </span>
                                </div>
                                ${result.species.length > 0 ? `
                                    <div style="color: #718096; font-size: 0.9em; margin-bottom: 5px;">
                                        Examples: ${result.species.slice(0, 3).join(', ')}
                                    </div>
                                    <div style="color: #a0aec0; font-size: 0.8em;">
                                        Sources: ${result.sources.join(', ')}
                                    </div>
                                ` : `
                                    <div style="color: #c53030; font-size: 0.9em;">
                                        ⚠️ System failure - no fallbacks worked
                                    </div>
                                `}
                            </div>
                        `;
                    });

                    resultsEl.innerHTML = html;
                } else {
                    resultsEl.innerHTML = `<div style="color: #c53030; padding: 12px; background: #fed7d7; border-radius: 6px;"><strong>Error:</strong> ${data.error}</div>`;
                }

            } catch (error) {
                resultsEl.innerHTML = `<div style="color: #c53030; padding: 12px; background: #fed7d7; border-radius: 6px;"><strong>Connection Error:</strong> ${error.message}</div>`;
            } finally {
                loadingEl.style.display = 'none';
            }
        }

        // Old functions removed - now using testSpeciesAtLocation for all species testing

        async function testSpeciesIdentification() {
            const lat = parseFloat(document.getElementById('species-test-lat').value);
            const lng = parseFloat(document.getElementById('species-test-lng').value);

            if (isNaN(lat) || isNaN(lng) || lat < -90 || lat > 90 || lng < -180 || lng > 180) {
                alert('Please enter valid coordinates (lat: -90 to 90, lng: -180 to 180)');
                return;
            }

            const loadingEl = document.getElementById('species-loading');
            const resultsEl = document.getElementById('species-results');

            loadingEl.style.display = 'block';
            resultsEl.innerHTML = '<p style="color: #718096;">Testing in progress...</p>';

            try {
                const response = await fetch('/api/admin/test-species', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ latitude: lat, longitude: lng })
                });

                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.error || 'Species test failed');
                }

                // Build results HTML
                let html = `
                    <div class="species-summary">
                        <h3>📊 Species Summary</h3>
                        <p><strong>Location:</strong> ${lat.toFixed(4)}, ${lng.toFixed(4)}</p>
                        <p><strong>Total Unique Species:</strong> ${data.summary.total}</p>
                    </div>

                    <div class="source-stats">
                        <div class="source-stat ${data.sourceStats.iNaturalist.error ? 'error' : ''}">
                            <div class="source-stat-number">${data.sourceStats.iNaturalist.count}</div>
                            <div class="source-stat-label">iNaturalist${data.sourceStats.iNaturalist.error ? ' (Error)' : ''}</div>
                        </div>
                        <div class="source-stat ${data.sourceStats.GBIF.error ? 'error' : ''}">
                            <div class="source-stat-number">${data.sourceStats.GBIF.count}</div>
                            <div class="source-stat-label">GBIF${data.sourceStats.GBIF.error ? ' (Error)' : ''}</div>
                        </div>
                        <div class="source-stat ${data.sourceStats.eBird.error ? 'error' : ''}">
                            <div class="source-stat-number">${data.sourceStats.eBird.count}</div>
                            <div class="source-stat-label">eBird${data.sourceStats.eBird.error ? ' (Error)' : ''}</div>
                        </div>
                    </div>
                `;

                // Add category breakdowns (insects excluded from species selection)
                const categoryOrder = ['bird', 'mammal', 'amphibian', 'reptile', 'fish', 'other'];
                const categoryIcons = {
                    bird: '🐦',
                    mammal: '🐾',
                    amphibian: '🐸',
                    reptile: '🦎',
                    fish: '🐟',
                    other: '❓'
                };

                categoryOrder.forEach(category => {
                    const species = data.categories[category] || [];
                    if (species.length > 0) {
                        html += `
                            <div class="species-category">
                                <h4>
                                    ${categoryIcons[category]} ${category.charAt(0).toUpperCase() + category.slice(1)}s
                                    <span class="species-count">${species.length}</span>
                                </h4>
                                <div class="species-list">
                        `;

                        species.forEach(s => {
                            html += `
                                <div class="species-item">
                                    <span class="species-name">${s.name}</span>
                                    ${s.scientificName ? `<br><span class="species-scientific">${s.scientificName}</span>` : ''}
                                    <span class="species-source">${s.source}</span>
                                </div>
                            `;
                        });

                        html += `
                                </div>
                            </div>
                        `;
                    }
                });

                if (data.summary.total === 0) {
                    html += `
                        <div class="species-category">
                            <h4>⚠️ No Species Found</h4>
                            <p style="color: #718096;">No species were found from any real-time API sources for this location. This indicates:</p>
                            <ul style="color: #718096; margin-left: 20px;">
                                <li>Remote location with limited observations</li>
                                <li>Recent API changes or connectivity issues</li>
                                <li>Location over water or in urban areas</li>
                            </ul>
                            <p style="color: #e53e3e; margin-top: 10px;"><strong>The system would fall back to the curated species database for meditation generation.</strong></p>
                        </div>
                    `;
                }

                resultsEl.innerHTML = html;

            } catch (error) {
                resultsEl.innerHTML = `
                    <div class="test-result error">
                        <strong>Error:</strong> ${error.message}
                    </div>
                `;
            } finally {
                loadingEl.style.display = 'none';
            }
        }

        // Test robust species system with error monitoring
        async function testSpeciesRobustness() {
            const loadingEl = document.getElementById('robust-loading');
            const resultsEl = document.getElementById('robust-results');
            const latInput = document.getElementById('species-test-lat');
            const lngInput = document.getElementById('species-test-lng');

            const lat = parseFloat(latInput.value);
            const lng = parseFloat(lngInput.value);

            if (isNaN(lat) || isNaN(lng)) {
                alert('Please enter valid latitude and longitude coordinates');
                return;
            }

            loadingEl.style.display = 'block';
            resultsEl.innerHTML = '';

            try {
                const response = await fetch('/api/admin/test-species', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ latitude: lat, longitude: lng })
                });

                const data = await response.json();

                if (data.success) {
                    let html = `
                        <div style="margin-bottom: 15px; padding: 10px; background: ${data.summary.hasZeroResults ? '#fff5f5' : '#f0fff4'}; border-radius: 6px;">
                            <div style="color: ${data.summary.hasZeroResults ? '#c53030' : '#38a169'}; font-weight: bold;">
                                ${data.summary.hasZeroResults ? '❌ SYSTEM FAILURE DETECTED' : '✅ SYSTEM HEALTHY'}
                            </div>
                            <div style="color: #718096; margin-top: 5px;">
                                Location: ${lat.toFixed(4)}, ${lng.toFixed(4)} | 
                                ${data.summary.successfulClasses}/${data.summary.totalClasses} classes returned results
                            </div>
                        </div>
                    `;

                    // Show results for each taxonomic class
                    data.results.forEach(result => {
                        const isError = result.count === 0;
                        const statusColor = isError ? '#c53030' : '#38a169';
                        const bgColor = isError ? '#fff5f5' : '#f0fff4';

                        html += `
                            <div style="margin-bottom: 10px; padding: 12px; background: ${bgColor}; border-radius: 6px; border-left: 4px solid ${statusColor};">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                    <h4 style="margin: 0; color: #2d3748;">${result.class}</h4>
                                    <span style="color: ${statusColor}; font-weight: bold;">
                                        ${isError ? '❌ ZERO RESULTS' : '✅ ' + result.count + ' species'}
                                    </span>
                                </div>
                                ${result.species.length > 0 ? `
                                    <div style="color: #718096; font-size: 0.9em; margin-bottom: 5px;">
                                        Sample species: ${result.species.join(', ')}
                                    </div>
                                    <div style="color: #a0aec0; font-size: 0.8em;">
                                        Sources: ${result.sources.join(', ')}
                                    </div>
                                ` : `
                                    <div style="color: #c53030; font-size: 0.9em; font-weight: bold;">
                                        CRITICAL ERROR: No fallbacks worked for this class!
                                    </div>
                                `}
                            </div>
                        `;
                    });

                    // Show any system errors
                    if (data.errors && data.errors.length > 0) {
                        html += `
                            <div style="margin-top: 15px; padding: 12px; background: #fed7d7; border-radius: 6px;">
                                <h4 style="color: #c53030; margin: 0 0 10px 0;">System Errors:</h4>
                                ${data.errors.map(error => `
                                    <div style="color: #c53030; font-size: 0.9em; margin-bottom: 5px;">
                                        <strong>${error.class}:</strong> ${error.message}
                                    </div>
                                `).join('')}
                            </div>
                        `;
                    }

                    // GBIF diagnostic (if present)
                    if (data.gbifDiagnostic) {
                        html += `
                            <div style="margin-top:15px; padding:12px; background:#fffaf0; border-radius:6px; border:1px solid #f6e05e;">
                                <h4 style="margin:0; color:#744210;">GBIF Diagnostic</h4>
                                <div style="color:#744210; margin-top:6px;">${escapeHtml(data.gbifDiagnostic.message || '')}</div>
                                ${data.gbifDiagnostic.rawSnippet ? `<pre style="background:#fff; padding:8px; border-radius:4px; overflow:auto; margin-top:8px;">${escapeHtml(data.gbifDiagnostic.rawSnippet)}</pre>` : ''}
                            </div>
                        `;
                    }

                    resultsEl.innerHTML = html;
                } else {
                    resultsEl.innerHTML = `
                        <div style="color: #c53030; padding: 12px; background: #fed7d7; border-radius: 6px;">
                            <strong>Test Failed:</strong> ${data.error}
                        </div>
                    `;
                }

            } catch (error) {
                console.error('Species robustness test error:', error);
                resultsEl.innerHTML = `
                    <div style="color: #c53030; padding: 12px; background: #fed7d7; border-radius: 6px;">
                        <strong>Connection Error:</strong> ${error.message}
                    </div>
                `;
            } finally {
                loadingEl.style.display = 'none';
            }
        }

        // Feedback Modal Functions
        function showFeedbackModal() {
            document.getElementById('feedback-modal').style.display = 'flex';
            updateSliderValues();
        }

        function closeFeedbackModal() {
            document.getElementById('feedback-modal').style.display = 'none';
        }

        function updateSliderValues() {
            document.getElementById('relevance-value').textContent = document.getElementById('rating-relevance').value;
            document.getElementById('groundedness-value').textContent = document.getElementById('rating-groundedness').value;
            document.getElementById('engagement-value').textContent = document.getElementById('rating-engagement').value;
            document.getElementById('tts-value').textContent = document.getElementById('rating-tts').value;
            document.getElementById('overall-value').textContent = document.getElementById('rating-overall').value;
        }

        // Update values on slider change
        document.getElementById('rating-relevance').addEventListener('input', () => document.getElementById('relevance-value').textContent = document.getElementById('rating-relevance').value);
        document.getElementById('rating-groundedness').addEventListener('input', () => document.getElementById('groundedness-value').textContent = document.getElementById('rating-groundedness').value);
        document.getElementById('rating-engagement').addEventListener('input', () => document.getElementById('engagement-value').textContent = document.getElementById('rating-engagement').value);
        document.getElementById('rating-tts').addEventListener('input', () => document.getElementById('tts-value').textContent = document.getElementById('rating-tts').value);
        document.getElementById('rating-overall').addEventListener('input', () => document.getElementById('overall-value').textContent = document.getElementById('rating-overall').value);

        async function submitFeedback() {
            const feedback = {
                relevance: parseInt(document.getElementById('rating-relevance').value),
                groundedness: parseInt(document.getElementById('rating-groundedness').value),
                engagement: parseInt(document.getElementById('rating-engagement').value),
                ttsQuality: parseInt(document.getElementById('rating-tts').value),
                overall: parseInt(document.getElementById('rating-overall').value),
                comments: document.getElementById('feedback-comments').value.trim(),
                timestamp: new Date().toISOString(),
                sessionId: 'admin-test-' + Date.now() // Placeholder for session tracking
            };

            try {
                const response = await fetch('/api/admin/feedback', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(feedback)
                });

                if (response.ok) {
                    alert('Thank you for your feedback!');
                    closeFeedbackModal();
                    // Reset form
                    document.getElementById('feedback-form').reset();
                    updateSliderValues();
                } else {
                    alert('Failed to submit feedback. Please try again.');
                }
            } catch (error) {
                console.error('Feedback submission error:', error);
                alert('Error submitting feedback: ' + error.message);
            }
        }

        // Load on page load
        loadConfig();
        loadStats();
        loadFeedbackStats();
        setInterval(loadStats, 10000); // Refresh stats every 10 seconds
        setInterval(loadFeedbackStats, 30000); // Refresh feedback every 30 seconds
    </script>

    <!-- Feedback Modal -->
    <div id="feedback-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
        <div style="background: white; padding: 30px; border-radius: 12px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto;">
            <h3 style="margin-bottom: 20px; color: #667eea;">Rate Your Meditation Experience</h3>
            <form id="feedback-form">
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">1. Relevance to Environment (1-10)</label>
                    <input type="range" id="rating-relevance" min="1" max="10" value="5" style="width: 100%;">
                    <span id="relevance-value" style="font-size: 0.9em; color: #666;">5</span>
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">2. Emotional Groundedness (1-10)</label>
                    <input type="range" id="rating-groundedness" min="1" max="10" value="5" style="width: 100%;">
                    <span id="groundedness-value" style="font-size: 0.9em; color: #666;">5</span>
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">3. Engagement with Nature (1-10)</label>
                    <input type="range" id="rating-engagement" min="1" max="10" value="5" style="width: 100%;">
                    <span id="engagement-value" style="font-size: 0.9em; color: #666;">5</span>
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">4. Audio/TTS Quality (1-10)</label>
                    <input type="range" id="rating-tts" min="1" max="10" value="5" style="width: 100%;">
                    <span id="tts-value" style="font-size: 0.9em; color: #666;">5</span>
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">5. Overall Satisfaction (1-10)</label>
                    <input type="range" id="rating-overall" min="1" max="10" value="5" style="width: 100%;">
                    <span id="overall-value" style="font-size: 0.9em; color: #666;">5</span>
                </div>
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Comments (Optional)</label>
                    <textarea id="feedback-comments" rows="3" style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #ddd;" placeholder="What stood out or could be improved?"></textarea>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button type="button" onclick="submitFeedback()" class="btn" style="flex: 1;">Submit Feedback</button>
                    <button type="button" onclick="closeFeedbackModal()" class="btn btn-secondary" style="flex: 1;">Cancel</button>
                </div>
            </form>
        </div>
    </div>
</body>
</html>
